{% extends "base.html" %}
{% block title %}Your Cart{% endblock %}

{% block content %}

{# === Include modal HTML once (outside tiles) === #}
{% include 'modals/cart_sellers_modal.html' %}
{% include 'modals/cart_individual_listings_modal.html' %}
{% include 'modals/remove_seller_confirmation_modal.html' %}
{% include 'modals/remove_listing_confirmation_modal.html' %}
{% include 'modals/cart_remove_item_confirmation_modal.html' %}
{% include 'modals/own_listings_skipped_modal.html' %}

{# Fonts (already in base; safe to keep if you prefer) #}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

{# === Page CSS === #}
<link rel="stylesheet" href="{{ url_for('static', filename='css/view_cart.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/pricing_badges.css') }}?v=1">

{# === Modal CSS (load the same styles the cart tab uses) === #}
<link rel="stylesheet" href="{{ url_for('static', filename='css/modals/confirmation_modal_base.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/modals/cart_sellers_modal.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/modals/cart_individual_listings_modal.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/modals/remove_seller_confirmation_modal.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/modals/remove_listing_confirmation_modal.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/modals/cart_remove_item_confirmation_modal.css') }}">

<div class="cart-page-content-container">
  <h2>Your Cart</h2>

  <!-- Price Update Warning for Dynamic Pricing -->
  <div class="price-update-warning">
    <div class="price-update-warning-icon">ⓘ</div>
    <div class="price-update-warning-content">
      <div class="price-update-warning-title">Live Pricing Active</div>
      <div class="price-update-warning-text">
        Cart prices are recalculated on every page load. Items with Premium-to-Spot pricing may have changed since you last viewed your cart.
      </div>
    </div>
  </div>

  <div class="cart-page-layout">
    <div class="cart-items-column">
      {% if buckets %}
        {% for bucket_id, bucket in buckets.items() %}
        <div class="cart-item-tile" data-bucket-id="{{ bucket_id }}">
          <!-- Image -->
          <div class="cart-image">
            <img src="{{ url_for('static', filename='img/placeholder.png') }}" alt="Product">
          </div>

          <!-- Item Details (two-column grid) -->
          <div class="cart-details">
            <div><strong>Metal:</strong> {{ bucket.category.metal }}</div>
            <div><strong>Product Type:</strong> {{ bucket.category.product_type }}</div>
            <div><strong>Weight:</strong> {{ bucket.category.weight }}</div>
            <div><strong>Purity:</strong> {{ bucket.category.purity or '--' }}</div>
            <div><strong>Mint:</strong> {{ bucket.category.mint }}</div>
            <div><strong>Year:</strong> {{ bucket.category.year }}</div>
            <div><strong>Finish:</strong> {{ bucket.category.finish }}</div>
            <div><strong>Grade:</strong> {{ bucket.category.grade }}</div>
            <div><strong>Product Line:</strong> {{ bucket.category.product_line or '--' }}</div>
            {% if bucket.listings %}
              {% set first_listing = bucket.listings[0] %}
              {% if first_listing.graded %}
                <div><strong>3rd party graded:</strong> Yes ({{ first_listing.grading_service }})</div>
              {% else %}
                <div><strong>3rd party graded:</strong> No</div>
              {% endif %}
            {% endif %}
          </div>

          <!-- Price & Quantity -->
          <div class="cart-meta">
            <div class="price">${{ bucket.avg_price|commas }}</div>
            <div class="price-subtext">per item</div>

            <!-- Pill qty dial -->
            <div class="cart-qty"
                 role="group"
                 aria-label="Quantity"
                 data-bucket-id="{{ bucket_id }}">
              <button class="cart-qty__btn cart-qty__minus" type="button" aria-label="Decrease quantity">−</button>
              <input
                class="cart-qty__value quantity-input"
                type="text"
                id="quantity-{{ bucket_id }}"
                inputmode="numeric"
                pattern="[0-9]*"
                min="1"
                max="{{ bucket.total_available }}"
                value="{{ bucket.total_qty }}"
                aria-live="polite"
              />
              <button class="cart-qty__btn cart-qty__plus" type="button" aria-label="Increase quantity">+</button>
            </div>
          </div>

          <!-- Footer buttons -->
          <div class="cart-footer">
            <button class="cart-btn" title="View Sellers" onclick="openSellerPopup({{ bucket_id }})">
              <i class="fa-solid fa-user"></i>
              <span>Sellers</span>
            </button>

            <button class="cart-btn" title="View Items" onclick="openPriceBreakdown({{ bucket_id }})">
              <i class="fa-solid fa-list"></i>
              <span>Items</span>
            </button>

            <button class="cart-btn" title="Remove" onclick="removeCartBucket({{ bucket_id }})">
              <i class="fa-solid fa-trash"></i>
              <span>Remove</span>
            </button>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <div class="empty-cart-container">
          <p class="empty-cart-message">Your cart is empty. Let's find some items!</p>
          <a href="{{ url_for('buy.buy') }}" style="text-decoration: none;">
            <button class="add-items-to-cart-given-empty-cart-btn">
              Add Items to Cart
            </button>
          </a>
        </div>
      {% endif %}
    </div>

    {% if buckets %}
    <div class="order-summary-card">
      <h3 class="summary-header">Order Summary</h3>

      {% for bucket_id, bucket in buckets.items() %}
        <div class="summary-item-section" data-bucket-id="{{ bucket_id }}">
          <div class="summary-item-name">{{ bucket.category.weight }} {{ bucket.category.metal }} {{ bucket.category.product_type }}</div>
          <div class="summary-line">
            <span class="summary-label">Quantity:</span>
            <span class="summary-value" id="summary-qty-{{ bucket_id }}">{{ bucket.total_qty }}</span>
          </div>
          <div class="summary-line">
            <span class="summary-label">Average Price:</span>
            <span class="summary-value">${{ bucket.avg_price|commas }}</span>
          </div>
          <div class="summary-line">
            <span class="summary-label">Subtotal:</span>
            <span class="summary-value" id="summary-total-{{ bucket_id }}">${{ bucket.total_price|commas }}</span>
          </div>
        </div>
      {% endfor %}

      <hr class="summary-divider">

      <div class="summary-line summary-total">
        <span class="summary-label">Total:</span>
        <span class="summary-value">${{ cart_total|commas }}</span>
      </div>

      {% if session.get('user_id') %}
        <button class="proceed-checkout-btn" onclick="openCheckoutModal()">Proceed to Checkout</button>
      {% else %}
        <a href="{{ url_for('auth.login') }}">
          <button class="proceed-checkout-btn">Login to Checkout</button>
        </a>
      {% endif %}
    </div>
    {% endif %}
  </div>
</div>

<!-- Pass per‐unit price arrays to JS -->
<script>
  const cartData = {
  {% for bucket_id, bucket in buckets.items() %}
    "{{ bucket_id }}": [
      {% for listing in bucket.listings %}
        {% for _ in range(listing.quantity) %}
          {{ listing.price_each }},
        {% endfor %}
      {% endfor %}
    ],
  {% endfor %}
  };
</script>

<!-- Flash Messages -->
{% set flashed = get_flashed_messages(with_categories=true) %}
{% if flashed %}
  <div class="flash-container">
    {% for msg in flashed %}
      <p class="flash-{{ msg[0] }}">{{ msg[1] }}</p>
    {% endfor %}
  </div>
{% endif %}

<script>
  setTimeout(() => {
    const flashContainer = document.querySelector('.flash-container');
    if (flashContainer) {
      flashContainer.style.transition = 'opacity 0.5s ease';
      flashContainer.style.opacity = '0';
      setTimeout(() => flashContainer.remove(), 500);
    }
  }, 3500);
</script>

<script>
  const sessionUserId = {{ 'null' if session.get('user_id') is none else session.get('user_id') }};
  // Flag to trigger "own listings skipped" modal
  window.showOwnListingsSkippedModal = {% if session.pop('show_own_listings_skipped_modal', False) %}true{% else %}false{% endif %};
  console.log('[DEBUG] Cart page loaded. showOwnListingsSkippedModal =', window.showOwnListingsSkippedModal);
</script>

{# === Page JS === #}
<script src="{{ url_for('static', filename='js/view_cart.js') }}"></script>

{# === Modal JS (load AFTER view_cart.js so these override the generic handlers) === #}
<script defer src="{{ url_for('static', filename='js/modals/cart_sellers_modal.js') }}"></script>
<script defer src="{{ url_for('static', filename='js/modals/cart_individual_listings_modal.js') }}"></script>
<script defer src="{{ url_for('static', filename='js/modals/own_listings_skipped_modal.js') }}"></script>
{# remove_seller_confirmation_modal.js and cart_remove_item_confirmation_modal.js are already included globally in base.html #}

{% endblock %}
