{% extends "base.html" %}
{% block title %}View Item{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/bucket.css') }}?v=fix-selected-shift">

<div id="popup-message-container"></div>

<!-- Item details container with white tile + 3D halo -->
<div class="bucket-page">
  <div class="bucket-card three-col">

    <!-- LEFT: full description tile -->
    <aside class="left-panel content-tile" aria-label="Item Specifications">
      <h3 class="specs-heading">Item Description</h3>
      <div class="specs-list">
        <div class="spec-row"><span class="spec-label">Metal</span><span class="spec-value">{{ specs['Metal'] or '--' }}</span></div>
        <div class="spec-row"><span class="spec-label">Product line</span><span class="spec-value">{{ specs['Product line'] or '--' }}</span></div>
        <div class="spec-row"><span class="spec-label">Product type</span><span class="spec-value">{{ specs['Product type'] or '--' }}</span></div>
        <div class="spec-row"><span class="spec-label">Weight</span><span class="spec-value">{{ specs['Weight'] or '--' }}</span></div>
        <div class="spec-row"><span class="spec-label">Year</span><span class="spec-value">{{ specs['Year'] or '--' }}</span></div>
        <div class="spec-row"><span class="spec-label">Mint</span><span class="spec-value">{{ specs['Mint'] or '--' }}</span></div>
        <div class="spec-row"><span class="spec-label">Purity</span><span class="spec-value">{{ specs['Purity'] or '--' }}</span></div>
        <div class="spec-row"><span class="spec-label">Finish</span><span class="spec-value">{{ specs['Finish'] or '--' }}</span></div>
        <div class="spec-row"><span class="spec-label">Grading</span><span class="spec-value">{{ specs['Grading'] or '--' }}</span></div>
      </div>
    </aside>

    <!-- CENTER: IMAGE (kept inside a content tile) -->
    <div class="bucket-main-image">
      <div class="image-box large-image">
        <span>Item Image</span>
      </div>
    </div>

    <!-- RIGHT: TITLE + PRICE + GRADING ACCORDION + CONTROLS -->
    <section class="bucket-controls content-tile" aria-label="Purchase controls">
      <!-- Title moved here -->
      <h1 class="right-title">
        {{ (bucket['weight'] or '') ~ ' ' ~ (bucket['metal'] or '') ~ ' ' ~ (bucket['product_type'] or '') }}
      </h1>

      <!-- Prominent price chip under title -->
      <div >
       
        <div class="price-amount">
          {% if availability['lowest_price'] %}
            ${{ '%.2f'|format(availability['lowest_price']) }} per coin
          {% else %}
            Price Unavailable
          {% endif %}
        </div>
      </div>

      <!-- Grading dropdown (accordion) ABOVE qty/buy/bid; expands vertically and pushes controls down -->
      <div class="grading-accordion" id="gradingAccordion">
        <button type="button"
                id="gradingAccordionButton"
                class="accordion-trigger"
                aria-expanded="false"
                aria-controls="gradingAccordionContent">
          Require 3rd-party grading?
          <span class="chev" aria-hidden="true"></span>
        </button>

        <!-- Toggles live INSIDE the expanding tile -->
        <div id="gradingAccordionContent" class="accordion-content" hidden>
          <div class="grading-toggles">
            <!-- Mutually exclusive by JS (radio-like behavior) -->
            <label class="grading-row">
              <span>Any Grader</span>
              <input type="checkbox" class="grader-toggle" name="any_grader" id="grading-any">
              <span class="grading-switch" aria-hidden="true"></span>
            </label>
            <label class="grading-row">
              <span>PCGS</span>
              <input type="checkbox" class="grader-toggle" name="pcgs" id="grading-pcgs">
              <span class="grading-switch" aria-hidden="true"></span>
            </label>
            <label class="grading-row">
              <span>NGC</span>
              <input type="checkbox" class="grader-toggle" name="ngc" id="grading-ngc">
              <span class="grading-switch" aria-hidden="true"></span>
            </label>
          </div>
        </div>
      </div>

      {% if availability['total_available'] > 0 %}
        <!-- Quantity row WITH availability on the same line -->
        <div class="qty-row">
          <div class="dial-pill buy-qty-pill"
               id="buyQtyPill"
               aria-label="Quantity selector"
               data-max="{{ availability['total_available'] }}">
            <button type="button" class="dial-btn minus" id="buyQtyMinus" aria-label="Decrease quantity">−</button>
            <div class="dial-value" id="buyQtyValue">1</div>
            <button type="button" class="dial-btn plus" id="buyQtyPlus" aria-label="Increase quantity">+</button>
          </div>
          <span class="qty-available">
            {{ availability['total_available'] }} available
          </span>
        </div>

        <!-- Hidden field that forms submit; kept named 'quantity' -->
        <input type="hidden" id="quantityInput" name="quantity" value="1">

        <!-- Buy Form -->
        <form method="POST" action="{{ url_for('checkout.checkout') }}">
          <input type="hidden" name="bucket_id" value="{{ bucket['id'] }}">
          <input type="hidden" name="quantity" id="buyQuantityInput">
          <button type="submit" class="btn buy-btn" onclick="syncQuantity('buyQuantityInput')">Buy Item</button>
        </form>

        <!-- Bid Link -->
        <a class="btn bid-btn"
          href="{{ url_for('bid.bid_page', bucket_id=bucket['id']) }}">
          + Create a Bid
        </a>


        <!-- Cart Form -->
        <form method="POST" action="{{ url_for('buy.auto_fill_bucket_purchase', bucket_id=bucket['id']) }}">
          <input type="hidden" name="quantity_to_buy" id="cartQuantityInput">
          <button type="submit" class="btn add-cart-btn" onclick="syncQuantity('cartQuantityInput')">Add to Cart</button>
        </form>
      {% else %}
        <p class="out-of-stock">Currently out of stock. Check back later or place a bid below.</p>
      {% endif %}
    </section>
  </div>
</div>

<!-- ===== BIDS PANEL (white content container) ===== -->
<section class="content-tile bids-panel" aria-label="Bids">
  {% if user_bids %}
  <section aria-label="Your active bids">
    <h3 class="bids-panel-heading">Your Active Bids</h3>

    <div class="account-bid-tiles">
      {% for bid in user_bids if bid['active'] and bid['status']|lower in ['open','pending','partially filled'] %}
        {% set requested = bid['quantity_requested'] or 0 %}
        {% set remaining = bid['remaining_quantity'] if bid['remaining_quantity'] is not none else requested %}
        {% set filled = requested - remaining %}
        <article class="account-bid-tile">
          <!-- Top line -->
          <div class="abt-top">
            <div class="abt-price">${{ '%.2f' | format(bid['price_per_coin']) }} <span class="abt-price-suffix">BID</span></div>
            <div class="abt-units">{{ requested }} units</div>
          </div>

          <!-- Second line -->
          <div class="abt-row">
            <div class="abt-curr">
              {% if availability['lowest_price'] %}
                Curr ${{ '%.2f' | format(availability['lowest_price']) }}
              {% else %}
                Curr $0.00
              {% endif %}
            </div>
            <div class="abt-filled">Filled: {{ filled }}</div>
          </div>

          <!-- Timestamp -->
          {% if bid['created_at'] %}
            <div class="abt-date">{{ bid['created_at'] }}</div>
          {% endif %}

          <!-- Action row -->
          <div class="abt-actions">
            <form method="GET" action="{{ url_for('bid.edit_bid', bid_id=bid['id']) }}">
              <button type="submit" class="abt-action">
                <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1.003 1.003 0 000-1.42l-2.34-2.34a1.003 1.003 0 00-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z"/></svg>
                <span>Edit</span>
              </button>
            </form>

            <form method="GET" action="{{ url_for('bid.edit_bid', bid_id=bid['id']) }}">
              <button type="submit" class="abt-action">
                <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M10 4h4l1 2h5v2H4V6h5l1-2zm1 6h2v8h-2v-8zm-4 0h2v8H7v-8zm8 0h2v8h-2v-8z"/></svg>
                <span>View</span>
              </button>
            </form>

            <form method="POST"
                  action="{{ url_for('bid.cancel_bid', bid_id=bid['id']) }}"
                  onsubmit="return confirm('Close (cancel) this bid?');">
              <button type="submit" class="abt-action">
                <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6 7h12l-1 14H7L6 7zm3-4h6l1 2h4v2H4V5h4l1-2z"/></svg>
                <span>Close</span>
              </button>
            </form>
          </div>
        </article>
      {% else %}
        <p>No open bids.</p>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  {% set ns = namespace(has_open=false) %}
  {% if bids %}
    {% for b in bids %}
      {% if b['status']|lower in ['open','pending','partially filled'] %}
        {% set ns.has_open = true %}
      {% endif %}
    {% endfor %}
  {% endif %}

  <form method="POST"
        action="{{ url_for('bid.accept_bid', bucket_id=bucket['id']) }}"
        id="accept-bids-form"
        class="bids-form">

    
    

    <div class="bids-header">
      <h3 class="bids-panel-heading">All Open Bids for This Item</h3>

      <div class="bids-actions">
        <!-- Bid Link (anchor styled like a button) -->
        <a class="btn bid-btn"
          href="{{ url_for('bid.bid_page', bucket_id=bucket['id']) }}">
          + Create a Bid
        </a>


        {% if ns.has_open %}
          <button type="submit"
                  class="btn accept-bids-btn"
                  id="acceptBidsButton"
                  disabled>
            Accept Bids
          </button>
        {% endif %}
      </div>
    </div>

    <h4 class="bids-subtext">Click to select bids</h4>

    <div class="bids-list-wrap">


      {% if bids and ns.has_open %}
        <div class="bids-list">
          {% for bid in bids if bid['status']|lower in ['open','pending','partially filled'] %}
          {% set max_qty = bid['remaining_quantity'] if bid['remaining_quantity'] is not none else bid['quantity_requested'] %}
          <div class="bid-row" data-bid-id="{{ bid['id'] }}" data-max="{{ max_qty }}">
            <input type="checkbox" name="selected_bids" value="{{ bid['id'] }}" class="selected-checkbox" hidden>

            <div class="bid-card-clickable bid-card-visual" role="button" tabindex="0" aria-pressed="false">
              {% if bid['requires_grading'] %}
              <div class="grading-dot" title="This bid requires graded items"></div>
              {% endif %}

              <div class="bid-card-content">
                <div class="bid-top-row">
                  <div class="bid-price-strong">${{ '%.2f' | format(bid['price_per_coin']) }} BID / unit</div>
                  <div class="bid-units">{{ max_qty }} units</div>
                </div>

                <div class="bid-seller">Seller: {{ bid['buyer_name'] }}</div>

                <div class="bid-meta">
                  <div class="bid-curr">
                    {% if availability['lowest_price'] %}
                      Curr ${{ '%.2f' | format(availability['lowest_price']) }}
                    {% else %}
                      Curr N/A
                    {% endif %}
                  </div>
                  {% if bid['created_at'] %}
                    <div class="bid-time">{{ bid['created_at'] }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="dial-assembly" id="dial_group_[{{ bid['id'] }}]" style="display:none;">
                <div class="dial-pill" data-bid-id="{{ bid['id'] }}" aria-label="Accepted quantity dial">
                  <div class="dial-fill"></div>
                  <button type="button" class="dial-btn minus" data-bid-id="{{ bid['id'] }}" aria-label="Decrease accepted quantity">−</button>
                  <div class="dial-value">0</div>
                  <button type="button" class="dial-btn plus" data-bid-id="{{ bid['id'] }}" aria-label="Increase accepted quantity">+</button>
                </div>
              </div>
            </div>

            <input type="hidden" name="accept_qty[{{ bid['id'] }}]" id="accept_qty_{{ bid['id'] }}" value="0">
          </div>
          {% endfor %}
        </div>
      {% else %}
        <p>No open bids at this time.</p>
      {% endif %}
    </div>
  </form>

</section>

<script>
  window.flashMessages = {{ get_flashed_messages(with_categories=true) | tojson }};
</script>
<script src="{{ url_for('static', filename='js/view_bucket.js') }}"></script>
{% endblock %}
