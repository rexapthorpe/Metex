{% extends "base.html" %}
{% block title %}View Item{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/bucket.css') }}?v=bucket-v4"/>
<link rel="stylesheet" href="{{ url_for('static', filename='css/modals/bucket_ID_sellers_modal.css') }}?v=bucket-v2"/>

<div id="popup-message-container"></div>

<div class="bucket-page">
  <!-- Top-half two-column layout (65% / 35%) -->
  <div class="bucket-card two-col-6535">

    <!-- ====================== LEFT COLUMN (65%) ====================== -->
    <section class="left-col" aria-label="Gallery and Description">
      <!-- Gallery: square main with in-tile arrows; grey placeholder if no images -->
      <div class="gallery">
        <div class="gallery-main" id="galleryMain" aria-live="polite">
          {% set has_images = images and images|length > 0 %}

          <button class="gal-arrow left" id="galPrev" aria-label="Previous image"
                  {% if not has_images or images|length < 2 %}disabled{% endif %}>‹</button>

          {% if has_images %}
            <img src="{{ images[0] }}" alt="Item image" id="mainImage">
          {% else %}
            <!-- Grey square placeholder (keeps 1:1 via CSS) -->
            <div id="mainImagePlaceholder" class="gallery-ph" aria-label="Image placeholder"></div>
          {% endif %}

          <button class="gal-arrow right" id="galNext" aria-label="Next image"
                  {% if not has_images or images|length < 2 %}disabled{% endif %}>›</button>

          <div class="gal-dots" id="galDots">
            {% if has_images %}
              {% for i in range(images|length) %}
                <span class="dot {{ 'active' if i == 0 else '' }}" data-idx="{{ i }}"></span>
              {% endfor %}
            {% endif %}
          </div>
        </div>

        <!-- Two square thumbnails (or grey square blocks if none) -->
        <!-- NEW: Row under the main image — thumbs (left) + sell stack (right) -->
        <div class="thumbs-row">
          <div class="thumbs">
            {% if has_images %}
              <button class="thumb" data-idx="0" aria-label="Show first image">
                <img src="{{ images[0] }}" alt="">
              </button>
              <button class="thumb" data-idx="1" aria-label="Show second image">
                <img src="{{ images[1] if images|length>1 else images[0] }}" alt="">
              </button>
            {% else %}
              <div class="thumb ph" aria-hidden="true"></div>
              <div class="thumb ph" aria-hidden="true"></div>
            {% endif %}
          </div>

          <div class="sell-stack">
            <div class="sell-kicker soft">List an Item?</div>
            <a class="sell-circle-btn" href="/sell" aria-label="Go to sell page">Sell</a>
          </div>
        </div>

      </div>

      <!-- Item Description tile: two spec columns + History + Description (single container) -->
      <article class="content-tile description-tile">
        <h3 class="section-heading">Item Description</h3>

        <div class="specs-two-col">
          <div class="spec-col">
            <div class="spec-row"><span class="spec-label">Metal</span><span class="spec-value">{{ specs['Metal'] or '--' }}</span></div>
            <div class="spec-row"><span class="spec-label">Product line</span><span class="spec-value">{{ specs['Product line'] or '--' }}</span></div>
            <div class="spec-row"><span class="spec-label">Product type</span><span class="spec-value">{{ specs['Product type'] or '--' }}</span></div>
            <div class="spec-row"><span class="spec-label">Weight</span><span class="spec-value">{{ specs['Weight'] or '--' }}</span></div>
            <div class="spec-row"><span class="spec-label">Grade</span><span class="spec-value">{{ specs['Grading'] or '--' }}</span></div>
          </div>
          <div class="spec-col">
            <div class="spec-row"><span class="spec-label">Year</span><span class="spec-value">{{ specs['Year'] or '--' }}</span></div>
            <div class="spec-row"><span class="spec-label">Mint</span><span class="spec-value">{{ specs['Mint'] or '--' }}</span></div>
            <div class="spec-row"><span class="spec-label">Purity</span><span class="spec-value">{{ specs['Purity'] or '--' }}</span></div>
            <div class="spec-row"><span class="spec-label">Finish</span><span class="spec-value">{{ specs['Finish'] or '--' }}</span></div>
          </div>
        </div>

        <div class="subsection">
          <h4 class="section-heading">History of the Item</h4>
          <p class="item-history">
          </p>
          <p class="item-description">
            {{ bucket['description'] if bucket['description'] else '—' }}
          </p>
        </div>
      </article>
    </section>

    <!-- ====================== RIGHT COLUMN (35%) ====================== -->
    <aside class="right-col content-tile" aria-label="Purchase and Bid Controls">

      <!-- Title aligned with top of image -->
      <h1 class="right-title">
        {% set title_parts = [bucket['Weight'], specs['Year'], bucket['metal'], specs['Product line'], specs['Purity'], bucket['product_type']] | select | list %}
        {{ title_parts | join(' ') }}
      </h1>

      {% if specs['Mint'] %}
        <p class="title-soft">Minted from the {{ specs['Mint'] }}</p>
      {% endif %}
      <hr class="divider">


      <!-- Sellers header/button/link -->
      <div class="sellers-cta">
        <div class="sellers-kicker">See all available sellers</div>
        <button id="openSellersBtn" class="btn sellers-btn" type="button">View All Sellers</button>
        <div class="sellers-foot">
          <a href="/sell" class="sellers-foot-link">List this item?</a>
        </div>
      </div>
      <hr class="divider">


      <!-- ===================== Accept Best Bid (two-column block) ===================== -->
      <section class="best-bid" id="bestBidBlock" aria-label="Accept best bid">
        {% if best_bid %}
          {% set max_qty = best_bid['remaining_quantity'] or best_bid['quantity_requested'] or 0 %}
          <div class="bb-grid">
            <!-- Left inner column: actions & See all bids -->
            <div class="bb-colL">
              <div class="bb-row1">
                <button class="btn best-bid-accept-btn" id="bbActionBtn" aria-expanded="false">Accept Bid</button>
              </div>
              <div class="bb-row2">
                <a href="#bidsSection" id="seeAllBidsLink" class="soft-link">See all bids</a>
              </div>
            </div>

            <!-- Right inner column: dial/close (row 1) + price (slides down into same column) -->
            <div class="bb-colR">
              <div class="bb-row1r">
                <!-- Price box: starts top-right; slides straight down in expanded state -->
                <div class="best-bid-price price-box" id="bestBidPriceBox">
                  <div id="bestBidPrice">${{ '%.2f'|format(best_bid['price_per_coin']) }} USD</div>
                  <div class="soft">Best bid per item</div>
                </div>

                <!-- Dial + Close; hidden initially -->
                <div class="bb-r1-flex" id="bbR1Flex">
                  <div class="dial-pill" id="acceptQtyDial" data-max="{{ max_qty }}" hidden>
                    <button type="button" class="dial-btn minus" id="acceptQtyMinus" aria-label="Decrease quantity">−</button>
                    <div class="dial-value" id="acceptQtyValue">1</div>
                    <button type="button" class="dial-btn plus" id="acceptQtyPlus" aria-label="Increase quantity">+</button>
                  </div>
                  <button class="bb-close" id="bbCloseBtn" aria-label="Cancel" hidden>×</button>
                </div>
              </div>

              <!-- NEW: layout spacer that expands only when Accept UI is open -->
              <div class="bb-spacer" id="bbSpacer" aria-hidden="true"></div>
            </div>


          </div>
        {% else %}
          <div class="best-bid-row disabled">
            <button class="btn best-bid-accept-btn" disabled>Accept Bid</button>
            <div class="best-bid-price">
              <div id="bestBidPrice">—</div>
              <div class="soft">No bids yet</div>
            </div>
          </div>
          <a href="#bidsSection" id="seeAllBidsLink" class="soft-link">See all bids</a>
        {% endif %}
      </section>
      <!-- ================================================================================ -->

      <hr class="divider">

      {% if availability['total_available'] > 0 %}
        {% if availability['lowest_price'] %}
          <div class="buy-block">
            <div class="best-ask-text">Best Ask</div>
            <div class="buy-price" aria-label="Current price">
              <span class="buy-price-amount">${{ '%.2f'|format(availability['lowest_price']) }} USD</span>
              <span class="soft">per item</span>
            </div>
          </div>
        {% else %}
          <div class="buy-price" aria-label="Current price">
            <span class="buy-price-amount">—</span>
            <span class="soft">No active listings</span>
          </div>
        {% endif %}

        <!-- Buy quantity dial with “Only N left” on the right -->
        <div class="qty-row">
          <div class="dial-pill buy-qty-pill" id="buyQtyPill" aria-label="Quantity selector" data-max="{{ availability['total_available'] }}">
            <button type="button" class="dial-btn minus" id="buyQtyMinus" aria-label="Decrease quantity">−</button>
            <div class="dial-value" id="buyQtyValue">1</div>
            <button type="button" class="dial-btn plus" id="buyQtyPlus" aria-label="Increase quantity">+</button>
          </div>
          <span class="qty-available">Only {{ availability['total_available'] }} left</span>
        </div>

        <!-- Hidden quantity used by actions -->
        <input type="hidden" id="quantityInput" name="quantity" value="1">

        <!-- Full-width CTAs -->
        <form method="POST" action="{{ url_for('checkout.checkout') }}" class="action-buttons">
          <input type="hidden" name="bucket_id" value="{{ bucket['id'] }}">
          <input type="hidden" name="quantity" id="buyQuantityInput">
          <button type="submit" class="btn buy-btn" onclick="syncQuantity('buyQuantityInput')">Buy Item</button>
        </form>

        <a class="btn bid-btn" href="{{ url_for('bid.bid_page', bucket_id=bucket['id']) }}">Make a Bid</a>

        <form method="POST" action="{{ url_for('buy.auto_fill_bucket_purchase', bucket_id=bucket['id']) }}" class="action-buttons">
          <input type="hidden" name="quantity_to_buy" id="cartQuantityInput">
          <button type="submit" class="btn add-cart-btn" onclick="syncQuantity('cartQuantityInput')">Add to Cart</button>
        </form>
      {% else %}
        <p class="out-of-stock">Currently out of stock. Check back later or place a bid below.</p>
      {% endif %}

      <hr class="divider">

      <!-- Shipping / Delivery / Payment block (two-column) -->
      <dl class="details-grid" id="shipPayBlock" aria-label="Shipping, delivery, payment">
        <dt>Shipping</dt>
        <dd>Free shipping.
            <span class="insured-by-UPS">Insured by UPS</span>
        </dd>


        <dt>Delivery</dt>
        <dd>Seller has 4 days to ship item at which point it can be tracked. If they fail to do so, the seller forfeits the item and you are refunded your money</dd>

        <dt>Payment Methods</dt>
        <dd>ACH, Bank Transfer, Credit Card, Debit Card</dd>
      </dl>


      <hr class="divider">
    </aside>
  </div>
</div>

<!-- ================== FULL-WIDTH BIDS SECTION (anchor target) ================== -->
<section class="content-tile bids-panel" id="bidsSection" aria-label="Bids">
  {% if user_bids %}
  <section aria-label="Your active bids">
    <h3 class="bids-panel-heading">Your Active Bids</h3>

    <div class="account-bid-tiles">
      {% for bid in user_bids if bid['active'] and bid['status']|lower in ['open','pending','partially filled'] %}
        {% set requested = bid['quantity_requested'] or 0 %}
        {% set remaining = bid['remaining_quantity'] if bid['remaining_quantity'] is not none else requested %}
        {% set filled = requested - remaining %}
        <article class="account-bid-tile">
          <div class="abt-top">
            <div class="abt-price">${{ '%.2f' | format(bid['price_per_coin']) }} <span class="abt-price-suffix">BID</span></div>
            <div class="abt-units">{{ requested }} units</div>
          </div>

          <div class="abt-row">
            <div class="abt-curr">
              {% if availability['lowest_price'] %}
                Curr ${{ '%.2f' | format(availability['lowest_price']) }}
              {% else %}
                Curr $0.00
              {% endif %}
            </div>
            <div class="abt-filled">Filled: {{ filled }}</div>
          </div>

          {% if bid['created_at'] %}<div class="abt-date">{{ bid['created_at'] }}</div>{% endif %}

          <div class="abt-actions">
            <form method="GET" action="{{ url_for('bid.edit_bid', bid_id=bid['id']) }}">
              <button type="submit" class="abt-action">
                <i class="fas fa-pencil-alt" aria-hidden="true"></i>
                <span>Edit</span>
              </button>
            </form>

            <form method="POST" action="{{ url_for('bid.cancel_bid', bid_id=bid['id']) }}" onsubmit="return confirm('Close (cancel) this bid?');">
              <button type="submit" class="abt-action">
                <i class="fa-solid fa-trash" aria-hidden="true"></i>
                <span>Close</span>
              </button>
            </form>
          </div>
        </article>
      {% else %}
        <p>No open bids.</p>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  {% set ns = namespace(has_open=false) %}
  {% if bids %}
    {% for b in bids %}
      {% if b['status']|lower in ['open','pending','partially filled'] %}
        {% set ns.has_open = true %}
      {% endif %}
    {% endfor %}
  {% endif %}

  <form method="POST" action="{{ url_for('bid.accept_bid', bucket_id=bucket['id']) }}" id="accept-bids-form" class="bids-form">
    <div class="bids-header">
      <h3 class="bids-panel-heading">All Open Bids for This Item</h3>

      <div class="bids-actions">
        <a class="btn bid-btn header-bid-btn" href="{{ url_for('bid.bid_page', bucket_id=bucket['id']) }}">+ Create a Bid</a>

        {% if ns.has_open %}
          <button type="submit" class="btn accept-bids-btn" id="acceptBidsButton" disabled>Accept Bids</button>
        {% endif %}
      </div>
    </div>

    <h4 class="bids-subtext">Click to select bids</h4>

    <div class="bids-list-wrap">
      {% if bids and ns.has_open %}
        <div class="bids-list">
          {% for bid in bids if bid['status']|lower in ['open','pending','partially filled'] %}
            {% set max_qty = bid['remaining_quantity'] if bid['remaining_quantity'] is not none else bid['quantity_requested'] %}
            <div class="bid-row" data-bid-id="{{ bid['id'] }}" data-max="{{ max_qty }}">
              <input type="checkbox" name="selected_bids" value="{{ bid['id'] }}" class="selected-checkbox" hidden>

              <div class="bid-card-clickable bid-card-visual" role="button" tabindex="0" aria-pressed="false">
                {% if bid['requires_grading'] %}
                <div class="grading-dot" title="This bid requires graded items"></div>
                {% endif %}

                <div class="bid-card-content">
                  <div class="bid-top-row">
                    <div class="bid-price-strong">${{ '%.2f' | format(bid['price_per_coin']) }} BID / unit</div>
                    <div class="bid-units">{{ max_qty }} units</div>
                  </div>

                  <div class="bid-seller">Seller: {{ bid['buyer_name'] }}</div>

                  <div class="bid-meta">
                    <div class="bid-curr">
                      {% if availability['lowest_price'] %}
                        Curr ${{ '%.2f' | format(availability['lowest_price']) }}
                      {% else %}
                        Curr N/A
                      {% endif %}
                    </div>
                    {% if bid['created_at'] %}<div class="bid-time">{{ bid['created_at'] }}</div>{% endif %}
                  </div>
                </div>

                <div class="dial-assembly" id="dial_group_[{{ bid['id'] }}]" style="display:none;">
                  <div class="dial-pill" data-bid-id="{{ bid['id'] }}" aria-label="Accepted quantity dial">
                    <div class="dial-fill"></div>
                    <button type="button" class="dial-btn minus" data-bid-id="{{ bid['id'] }}" aria-label="Decrease accepted quantity">−</button>
                    <div class="dial-value">0</div>
                    <button type="button" class="dial-btn plus" data-bid-id="{{ bid['id'] }}" aria-label="Increase accepted quantity">+</button>
                  </div>
                </div>
              </div>

              <input type="hidden" name="accept_qty[{{ bid['id'] }}]" id="accept_qty_{{ bid['id'] }}" value="0">
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p>No open bids at this time.</p>
      {% endif %}
    </div>
  </form>
</section>

<!-- ============ Sellers Modal Markup ============ -->
{% include 'modals/bucket_ID_sellers_modal.html' %}

<script>
  window.flashMessages = {{ get_flashed_messages(with_categories=true) | tojson }};
  window.bucketImages  = {{ (images or []) | tojson }};
  window.bestBid       = {{ (best_bid or {}) | tojson }};
  window.bucketId      = {{ bucket['id'] }};
</script>
<script src="{{ url_for('static', filename='js/modals/bucket_ID_sellers_modal.js') }}?v=bucket-v2"></script>
<script src="{{ url_for('static', filename='js/view_bucket.js') }}?v=bucket-v4"></script>
{% endblock %}
