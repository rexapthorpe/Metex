{# templates/tabs/cart_tab.html #}

<!-- Cart page styles -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/view_cart.css') }}">

<!-- Modal styles -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/modals/cart_remove_item_confirmation_modal.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/modals/remove_listing_confirmation_modal.css') }}">

<h2 class="tab-heading">My Cart</h2>

<div class="cart-page-layout cart-tab">
  <div class="cart-items-column">
    {% if buckets %}
      {% for bucket_id, bucket in buckets.items() %}
        <div class="cart-item-tile" data-bucket-id="{{ bucket_id }}">
          <!-- Image -->
          <div class="cart-image">
            <img src="{{ url_for('static', filename='img/placeholder.png') }}" alt="Product">
          </div>

          <!-- Item Details (two-column grid) -->
          <div class="cart-details">
            <div><strong>Metal:</strong> {{ bucket.category.metal }}</div>
            <div><strong>Product Type:</strong> {{ bucket.category.product_type }}</div>
            <div><strong>Weight:</strong> {{ bucket.category.weight }}</div>
            <div><strong>Purity:</strong> {{ bucket.category.purity }}</div>
            <div><strong>Mint:</strong> {{ bucket.category.mint }}</div>
            <div><strong>Year:</strong> {{ bucket.category.year }}</div>
            <div><strong>Finish:</strong> {{ bucket.category.finish }}</div>
            <div><strong>Grade:</strong> {{ bucket.category.grade }}</div>
            <div><strong>Product Line:</strong> {{ bucket.category.product_line }}</div>
            {% if bucket.listings %}
              {% set first_listing = bucket.listings[0] %}
              {% if first_listing.graded %}
                <div><strong>3rd party graded:</strong> Yes ({{ first_listing.grading_service }})</div>
              {% else %}
                <div><strong>3rd party graded:</strong> No</div>
              {% endif %}
            {% endif %}
          </div>

          <!-- Price & Quantity -->
          <div class="cart-meta">
            <div class="price">${{ '%.2f'|format(bucket.avg_price) }}</div>
            <div class="price-subtext">per item</div>

            <!-- Pill qty dial -->
            <div class="cart-qty"
                 role="group"
                 aria-label="Quantity"
                 data-bucket-id="{{ bucket_id }}">
              <button class="cart-qty__btn cart-qty__minus" type="button" aria-label="Decrease quantity">âˆ’</button>
              <input
                class="cart-qty__value quantity-input"
                type="text"
                id="quantity-{{ bucket_id }}"
                inputmode="numeric"
                pattern="[0-9]*"
                min="1"
                max="{{ bucket.total_available }}"
                value="{{ bucket.total_qty }}"
                aria-live="polite"
              />
              <button class="cart-qty__btn cart-qty__plus" type="button" aria-label="Increase quantity">+</button>
            </div>
          </div>

          <!-- Footer buttons -->
          <div class="cart-footer">
            <button class="cart-btn" title="View Sellers" onclick="openSellerPopup({{ bucket_id }})">
              <i class="fa-solid fa-user"></i>
              <span>Sellers</span>
            </button>

            <button class="cart-btn" title="View Items" onclick="openPriceBreakdown({{ bucket_id }})">
              <i class="fa-solid fa-list"></i>
              <span>Items</span>
            </button>

            <button class="cart-btn" title="Remove" onclick="openRemoveItemModal({{ bucket_id }})">
              <i class="fa-solid fa-trash"></i>
              <span>Remove</span>
            </button>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="empty-cart-container-car-tab">
        <p class="empty-cart-message">Your cart is empty. Let's find some items!</p>
        <a href="{{ url_for('buy.buy') }}">
          <button class="add-items-to-cart-given-empty-cart-btn-cart-tab">
            Add Items to Cart
          </button>
        </a>
      </div>
    {% endif %}
  </div>

  {# Order Summary - receipt-style layout matching cart page #}
  {% if buckets %}
  <div class="order-summary-card">
    <h3 class="summary-header">Order Summary</h3>

    {% for bucket_id, bucket in buckets.items() %}
      <div class="summary-item-section" data-bucket-id="{{ bucket_id }}">
        <div class="summary-item-name">{{ bucket.category.weight }} {{ bucket.category.metal }} {{ bucket.category.product_type }}</div>
        <div class="summary-line">
          <span class="summary-label">Quantity:</span>
          <span class="summary-value" id="summary-qty-{{ bucket_id }}">{{ bucket.total_qty }}</span>
        </div>
        <div class="summary-line">
          <span class="summary-label">Average Price:</span>
          <span class="summary-value">${{ '%.2f' % bucket.avg_price }}</span>
        </div>
        <div class="summary-line">
          <span class="summary-label">Subtotal:</span>
          <span class="summary-value" id="summary-total-{{ bucket_id }}">${{ '%.2f' % bucket.total_price }}</span>
        </div>
      </div>
    {% endfor %}

    <hr class="summary-divider">

    <div class="summary-line summary-total">
      <span class="summary-label">Total:</span>
      <span class="summary-value">${{ '%.2f' % cart_total }}</span>
    </div>

    {% if session.get('user_id') %}
      <button class="proceed-checkout-btn" onclick="openCheckoutModal()">Proceed to Checkout</button>
    {% else %}
      <a href="{{ url_for('auth.login') }}">
        <button class="proceed-checkout-btn">Login to Checkout</button>
      </a>
    {% endif %}
  </div>
  {% endif %}
</div>

<!-- Pass per-unit price arrays to JS for quantity calculations -->
<script>
  const cartData = {
  {% for bucket_id, bucket in buckets.items() %}
    "{{ bucket_id }}": [
      {% for listing in bucket.listings %}
        {% for _ in range(listing.quantity) %}
          {{ listing.effective_price }},
        {% endfor %}
      {% endfor %}
    ],
  {% endfor %}
  };
</script>

{# Modals are included at the account.html page level, not here #}
