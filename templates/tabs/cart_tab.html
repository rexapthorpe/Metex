{# templates/tabs/cart_tab.html #}

<!-- bring in the remove-item confirmation styling -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/modals/cart_remove_item_confirmation_modal.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/modals/remove_listing_confirmation_modal.css') }}">

<h2 class="tab-heading">My Cart</h2>

<div class="cart-page-layout cart-tab">
  <div class="cart-items-column">
    {% if buckets %}
      {% for bucket_id, bucket in buckets.items() %}
        <div class="cart-item-tile" data-bucket-id="{{ bucket_id }}">
          <div class="tile-image">Image</div>

          <div class="tile-info">
            <!-- INFO + PRICE + QTY ROW (identical structure to view_cart.html) -->
            <div class="tile-info-main">
              <div class="tile-info-left">
                <h3>{{ bucket.category.weight }} {{ bucket.category.metal }} {{ bucket.category.product_type }}</h3>
                <p>
                  <strong>Mint:</strong> {{ bucket.category.mint }}<br>
                  <strong>Year:</strong> {{ bucket.category.year }}<br>
                  <strong>Finish:</strong> {{ bucket.category.finish }}<br>
                  <strong>Grade:</strong> {{ bucket.category.grade }}
                </p>
                {% if bucket.grading_preference %}
                  <p><strong>Grading Preference:</strong> {{ bucket.grading_preference }}</p>
                {% endif %}
              </div>

              <div class="tile-info-right">
                <div class="item-price avg-price">
                  ${{ '%.2f'|format(bucket.avg_price) }}
                </div>
                <span class="price-subtext">price per item</span>

                <!-- Pill qty dial (class names match view_cart for shared styles/JS) -->
                <div class="quantity-controls">
                  <div class="cart-qty"
                       role="group"
                       aria-label="Quantity"
                       data-bucket-id="{{ bucket_id }}">
                    <button class="cart-qty__btn cart-qty__minus" type="button" aria-label="Decrease quantity">âˆ’</button>
                    <input
                      class="cart-qty__value quantity-input"
                      type="text"
                      id="quantity-{{ bucket_id }}"
                      inputmode="numeric"
                      pattern="[0-9]*"
                      min="1"
                      max="{{ bucket.total_available }}"
                      value="{{ bucket.total_qty }}"
                      aria-live="polite"
                    />
                    <button class="cart-qty__btn cart-qty__plus" type="button" aria-label="Increase quantity">+</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Buttons row (right-aligned, same as view_cart) -->
            <div class="tile-actions-inline">
              <button
                class="icon-button"
                title="View Sellers"
                onclick="openSellerPopup({{ bucket_id }})">
                <i class="fa-solid fa-user"></i>
                <span class="icon-label">Sellers</span>
              </button>

              <button
                class="icon-button"
                title="View Items"
                onclick="openPriceBreakdown({{ bucket_id }})">
                <i class="fa-solid fa-list"></i>
                <span class="icon-label">Items</span>
              </button>

              <button
                class="icon-button"
                title="Remove"
                onclick="openRemoveItemModal({{ bucket_id }})">
                <i class="fa-solid fa-trash"></i>
                <span class="icon-label">Remove</span>
              </button>
            </div>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <div class="empty-cart-container-car-tab">
        <p class="empty-cart-message">Your cart is empty. Let's find some items!</p>
        <a href="{{ url_for('buy.buy') }}">
          <button class="add-items-to-cart-given-empty-cart-btn-cart-tab">
            Add Items to Cart
          </button>
        </a>
      </div>
    {% endif %}
  </div>

  {# Order Summary - same as cart page #}
  {% if buckets %}
  <div class="cart-summary-fixed">
    <h3>Order Summary</h3>
    {% for bucket_id, bucket in buckets.items() %}
      <div class="summary-line" data-bucket-id="{{ bucket_id }}">
        <p><strong>{{ bucket.category.metal }} {{ bucket.category.product_type }}</strong></p>
        <p class="summary-qty" id="summary-qty-{{ bucket_id }}">Quantity: {{ bucket.total_qty }}</p>
        <p>Avg Price: ${{ '%.2f' % bucket.avg_price }}</p>
        <p class="summary-total" id="summary-total-{{ bucket_id }}">Total: ${{ '%.2f' % bucket.total_price }}</p>
        <hr>
      </div>
    {% endfor %}
    <p><strong>Total for All Items:</strong> ${{ '%.2f' % cart_total }}</p>
    {% if session.get('user_id') %}
      <a href="{{ url_for('checkout.checkout') }}">
        <button class="btn proceed-btn">Proceed to Checkout</button>
      </a>
    {% else %}
      <a href="{{ url_for('auth.login') }}">
        <button class="btn login-btn">Login to Checkout</button>
      </a>
    {% endif %}
  </div>
  {% endif %}
</div>

<!-- Pass per-unit price arrays to JS for quantity calculations -->
<script>
  const cartData = {
  {% for bucket_id, bucket in buckets.items() %}
    "{{ bucket_id }}": [
      {% for listing in bucket.listings %}
        {% for _ in range(listing.quantity) %}
          {{ listing.price_per_coin }},
        {% endfor %}
      {% endfor %}
    ],
  {% endfor %}
  };
</script>

{# Modals are included at the account.html page level, not here #}
