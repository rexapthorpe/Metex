{# templates/tabs/bids_tab.html — My Bids + Edit‐Bid Modal container #}

<div class="bids-container bids-tab">
  <h2 class="tab-heading">My Bids</h2>

  {# Group by status. Note: backend uses 'Partially Filled' (not 'Partial'). #}
  {% set groups = {
    'Open Bids': bids | selectattr('status','equalto','Open') | list,
    'Partially Filled Bids': bids | selectattr('status','equalto','Partially Filled') | list,
    'Filled Bids': bids | selectattr('status','equalto','Filled') | list
  } %}

  {% for heading, items in groups.items() %}
    {% if items %}
      <section class="bids-group">
        <h3 class="bids-group-title">{{ heading }}</h3>
        <div class="bids-grid">
          {% for bid in items %}
            {% set remaining = (bid.remaining_quantity if bid.remaining_quantity is not none else bid.quantity_requested) %}
            {% set filled_units_calc = (bid.quantity_requested or 0) - (remaining or 0) %}
            {% set filled_units = 0 if filled_units_calc < 0 else filled_units_calc %}

            <div class="bid-card">
              <div class="bid-card-header">
                <span class="bid-title">{{ bid.weight }} {{ bid.product_line or bid.product_type }} {{ bid.year }}</span>

                {# Show remaining units; avoid "or" fallback because 0 is falsy in Jinja. #}
                {% if bid.status == 'Filled' %}
                  <span class="bid-quantity">0 Open</span>
                {% else %}
                  <span class="bid-quantity">{{ remaining }} Open</span>
                {% endif %}
              </div>

              <div class="bid-card-price-row">
                {% if bid.pricing_mode == 'premium_to_spot' %}
                  {# Variable (Premium-to-Spot) Bid #}
                  <span class="bid-price bid-price-variable">
                    <span style="font-size: 11px; color: #1976d2; font-weight: 600; display: block; margin-bottom: 2px;">VARIABLE</span>
                    Spot + ${{ '%.2f'|format(bid.spot_premium or 0) }}
                    <span style="font-size: 11px; color: #666; display: block; margin-top: 2px;">
                      (Max: ${{ '{:,.2f}'.format(bid.bid_ceiling_price_display or 0) }})
                    </span>
                  </span>
                {% else %}
                  {# Fixed Price Bid #}
                  <span class="bid-price">${{ '%.2f'|format(bid.price_per_coin) }} Bid</span>
                {% endif %}

                {# Show filled/total quantity #}
                {% if bid.status == 'Filled' %}
                  <span class="bid-filled">{{ bid.quantity_requested or 0 }}/{{ bid.quantity_requested or 0 }} Filled</span>
                {% else %}
                  <span class="bid-filled">{{ filled_units }}/{{ bid.quantity_requested or 0 }} Filled</span>
                {% endif %}
              </div>

              <div class="bid-card-subheader">
                {# Show listing effective price (max of spot+premium and floor for variable listings) #}
                <span class="bid-current" style="display: block; margin-bottom: 4px;">
                  Current listing effective price:
                  {% if bid.listing_effective_price is not none %}
                    ${{ '{:,.2f}'.format(bid.listing_effective_price) }}
                  {% else %}
                    No current listings
                  {% endif %}
                </span>

                {# Show bid effective price (min of spot+premium and ceiling for variable bids) #}
                {% if bid.pricing_mode == 'premium_to_spot' %}
                  <span class="bid-current" style="display: block; color: #1976d2;">
                    Current bid effective price: ${{ '{:,.2f}'.format(bid.bid_effective_price) }}
                  </span>
                {% endif %}
              </div>

              <div class="bid-card-timestamp">{{ bid.created_at }}</div>

              <div class="bid-card-actions">
                {% if bid.status == 'Open' %}
                  <button
                    type="button"
                    onclick="openBidModal({{ bid.category_id }}, {{ bid.id }})"
                    class="icon-text-btn btn-edit"
                  >
                    <i class="fas fa-pencil-alt"></i> Edit
                  </button>
                  <a
                    href="{{ url_for('buy.view_bucket', bucket_id=bid.bucket_id) }}"
                    class="icon-text-btn btn-view"
                  >
                    <i class="fas fa-binoculars"></i> View
                  </a>
                  <button
                    type="button"
                    onclick="closeBid({{ bid.id }})"
                    class="icon-text-btn btn-close"
                  >
                    <i class="fas fa-trash"></i> Close
                  </button>
                {% else %}
                  <a
                    href="{{ url_for('buy.view_bucket', bucket_id=bid.bucket_id) }}"
                    class="icon-text-btn btn-view"
                  >
                    <i class="fas fa-binoculars"></i> View
                  </a>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      </section>
    {% endif %}
  {% endfor %}

  {% if not bids %}
    <p class="no-bids">You have no bids yet!</p>
  {% endif %}
</div>

{# include the unified bid modal container; bid_modal.js will load the form into #bidModalContent #}
{% include 'modals/bid_modal.html' %}
