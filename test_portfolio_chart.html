<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Chart Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .portfolio-chart-container {
            height: 400px;
            margin: 20px 0;
            border: 1px solid #e5e7eb;
            padding: 20px;
            background: white;
        }
        .time-range-selector {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        .time-btn {
            padding: 8px 16px;
            border: 1px solid #d1d5db;
            background: white;
            cursor: pointer;
            border-radius: 6px;
        }
        .time-btn.active {
            background: #3b82f6;
            color: white;
        }
        .test-info {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>Portfolio Chart Test</h1>

    <div class="test-info">
        <h3>Test Status</h3>
        <div id="status">Initializing...</div>
    </div>

    <div class="time-range-selector">
        <button class="time-btn" data-range="1d">1D</button>
        <button class="time-btn" data-range="1w">1W</button>
        <button class="time-btn active" data-range="1m">1M</button>
        <button class="time-btn" data-range="3m">3M</button>
        <button class="time-btn" data-range="1y">1Y</button>
    </div>

    <div class="portfolio-chart-container">
        <canvas id="portfolio-value-chart"></canvas>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <script>
        let portfolioValueChart = null;
        let currentTimeRange = '1m';

        function log(message) {
            const statusEl = document.getElementById('status');
            const time = new Date().toLocaleTimeString();
            statusEl.innerHTML += `<br>[${time}] ${message}`;
        }

        function setupTimeRangeSelector() {
            const timeBtns = document.querySelectorAll('.time-btn');

            timeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const range = btn.getAttribute('data-range');
                    log(`Time range clicked: ${range}`);

                    // Update active state
                    timeBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    // Load new data
                    currentTimeRange = range;
                    loadPortfolioHistory(range);
                });
            });

            log('Time range selector initialized');
        }

        function loadPortfolioHistory(range) {
            log(`Loading history for range: ${range}`);

            fetch(`/portfolio/history?range=${range}`)
                .then(response => {
                    log(`Received response: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    log(`Data received: ${JSON.stringify(data).substring(0, 100)}...`);

                    if (data.success) {
                        log(`History entries: ${data.history.length}`);
                        renderValueChart(data.history);
                    } else {
                        log('ERROR: ' + (data.error || 'Unknown error'));
                    }
                })
                .catch(error => {
                    log('FETCH ERROR: ' + error.message);
                    console.error('[Portfolio] Error loading history:', error);
                });
        }

        function renderValueChart(historyData) {
            const ctx = document.getElementById('portfolio-value-chart');

            if (!ctx) {
                log('ERROR: Canvas element not found!');
                return;
            }

            log(`Rendering chart with ${historyData.length} data points`);

            // Prepare data
            const labels = historyData.map(item => {
                const date = new Date(item.date);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });

            const values = historyData.map(item => item.value);
            const costBasis = historyData.map(item => item.cost_basis);

            log(`Labels: ${labels.join(', ')}`);
            log(`Values: ${values.join(', ')}`);

            // Destroy existing chart if it exists
            if (portfolioValueChart) {
                log('Destroying existing chart');
                portfolioValueChart.destroy();
            }

            // Create gradient
            const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(0, 102, 204, 0.15)');
            gradient.addColorStop(1, 'rgba(0, 102, 204, 0)');

            // Create chart
            try {
                portfolioValueChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Portfolio Value',
                                data: values,
                                borderColor: '#0066cc',
                                backgroundColor: gradient,
                                borderWidth: 3,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 3,
                                pointHoverRadius: 6,
                                pointHoverBackgroundColor: '#0066cc',
                                pointHoverBorderColor: '#ffffff',
                                pointHoverBorderWidth: 2
                            },
                            {
                                label: 'Cost Basis',
                                data: costBasis,
                                borderColor: '#9ca3af',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                fill: false,
                                tension: 0.4,
                                pointRadius: 3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                align: 'end'
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.9)',
                                padding: 12,
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                grid: {
                                    color: '#f3f4f6'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return '$' + value.toFixed(0);
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });

                log('âœ“ Chart created successfully!');
            } catch (error) {
                log('ERROR creating chart: ' + error.message);
                console.error('Chart error:', error);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            log('DOM Content Loaded');
            log('Chart.js loaded: ' + (typeof Chart !== 'undefined' ? 'YES' : 'NO'));

            setupTimeRangeSelector();

            // Load initial data
            log('Loading initial portfolio history...');
            loadPortfolioHistory('1m');
        });
    </script>
</body>
</html>
