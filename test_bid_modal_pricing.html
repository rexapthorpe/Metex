<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bid Modal Pricing Mode Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .test-container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .feature-block {
      margin-bottom: 20px;
    }
    .eb-label {
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
    }
    .eb-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .eb-hint {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }
    .qty-dial {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }
    .qty-btn {
      width: 32px;
      height: 32px;
      border: 1px solid #ddd;
      background: white;
      border-radius: 4px;
      cursor: pointer;
      font-size: 18px;
    }
    .qty-btn:hover {
      background: #f0f0f0;
    }
    .qty-value {
      min-width: 40px;
      text-align: center;
      font-size: 18px;
      font-weight: 600;
    }
    .input-prefix input {
      padding-left: 20px;
    }
    .input-prefix::before {
      content: '$';
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
    }
    .input-prefix {
      position: relative;
      display: inline-block;
      width: 100%;
    }
    .price-qty-row {
      display: flex;
      gap: 16px;
    }
    .qty-block {
      flex: 1;
    }
    .price-block {
      flex: 1;
    }
    .test-status {
      margin-top: 20px;
      padding: 12px;
      border-radius: 4px;
      font-size: 14px;
    }
    .test-status.success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }
    .test-status.error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }
    .eb-confirm {
      margin-top: 20px;
      padding: 12px 24px;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 16px;
      cursor: pointer;
    }
    .eb-confirm:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="test-container">
    <h1>Bid Modal Pricing Mode Test</h1>
    <p>Test the pricing mode toggle between Fixed Price and Variable (Premium to Spot)</p>

    <!-- Pricing Mode Selector -->
    <div class="feature-block">
      <div class="eb-label">Pricing Mode</div>
      <select id="bid-pricing-mode" class="eb-input">
        <option value="static" selected>Fixed Price</option>
        <option value="premium_to_spot">Variable (Premium to Spot)</option>
      </select>
      <div class="eb-hint">
        Fixed Price: set a specific dollar amount | Variable: bid tracks live spot price + your premium
      </div>
    </div>

    <!-- Static Pricing Fields -->
    <div id="static-pricing-fields" class="price-qty-row feature-block">
      <div class="qty-block">
        <div class="eb-label">Quantity</div>
        <div class="qty-dial">
          <button type="button" id="qty-dec" class="qty-btn">−</button>
          <span id="qty-value" class="qty-value">1</span>
          <button type="button" id="qty-inc" class="qty-btn">＋</button>
        </div>
        <input id="qty-input" type="number" min="1" step="1" value="1" style="display:none;">
        <div id="qty-hint" class="eb-hint"></div>
      </div>

      <div class="price-block">
        <div class="eb-label">Price Per Item</div>
        <div class="input-prefix">
          <input id="bid-price-input" type="number" step="0.01" min="0.01" placeholder="0.00" class="eb-input">
        </div>
        <div id="price-hint" class="eb-hint"></div>
      </div>
    </div>

    <!-- Premium Pricing Fields -->
    <div id="premium-pricing-fields" style="display: none;">
      <div class="feature-block">
        <div class="eb-label">Quantity</div>
        <div class="qty-dial">
          <button type="button" id="qty-dec-premium" class="qty-btn">−</button>
          <span id="qty-value-premium" class="qty-value">1</span>
          <button type="button" id="qty-inc-premium" class="qty-btn">＋</button>
        </div>
        <input id="qty-input-premium" type="number" min="1" step="1" value="1" style="display:none;">
      </div>

      <div class="feature-block">
        <div class="eb-label">Premium Above Spot</div>
        <div class="input-prefix">
          <input id="bid-spot-premium" type="number" step="0.01" min="0" value="0.00" placeholder="0.00" class="eb-input">
        </div>
        <div class="eb-hint">Amount to add above current spot price per unit</div>
      </div>

      <div class="feature-block">
        <div class="eb-label">No Higher Than (Price Ceiling)</div>
        <div class="input-prefix">
          <input id="bid-floor-price" type="number" step="0.01" min="0.01" placeholder="0.00" class="eb-input">
        </div>
        <div class="eb-hint">Maximum price ceiling - your bid won't exceed this amount</div>
      </div>

      <div class="feature-block" style="padding: 10px; background: #f5f5f5; border-radius: 4px;">
        <div style="font-size: 13px; color: #333; margin-bottom: 4px;">
          <strong>Current Gold Spot Price:</strong>
        </div>
        <div id="current-spot-price" style="font-size: 20px; font-weight: 600; color: #1976d2;">
          $2650.00
        </div>
        <div style="font-size: 11px; color: #666; margin-top: 4px;">
          Your bid: Spot + $<span id="premium-display">0.00</span>
          = $<span id="effective-bid-price">2650.00</span>
        </div>
      </div>
    </div>

    <!-- Dummy address fields -->
    <input type="hidden" id="addr-line1" value="123 Main St">
    <input type="hidden" id="addr-city" value="New York">
    <input type="hidden" id="addr-state" value="NY">
    <input type="hidden" id="addr-zip" value="10001">

    <button id="eb-confirm" type="button" class="eb-confirm">Confirm</button>

    <div id="test-status" class="test-status" style="display:none;"></div>
  </div>

  <script>
    // Minimal bid_modal.js implementation for testing
    const pricingModeSelect = document.getElementById('bid-pricing-mode');
    const staticPricingFields = document.getElementById('static-pricing-fields');
    const premiumPricingFields = document.getElementById('premium-pricing-fields');
    const premiumDisplay = document.getElementById('premium-display');
    const effectiveBidPrice = document.getElementById('effective-bid-price');
    const currentSpotPriceElem = document.getElementById('current-spot-price');
    const confirmBtn = document.getElementById('eb-confirm');
    const priceInput = document.getElementById('bid-price-input');
    const priceHint = document.getElementById('price-hint');
    const qtyInput = document.getElementById('qty-input');
    const qtyValue = document.getElementById('qty-value');
    const qtyHint = document.getElementById('qty-hint');
    const qtyDec = document.getElementById('qty-dec');
    const qtyInc = document.getElementById('qty-inc');

    // Validation function
    function validateAll() {
      const pricingMode = pricingModeSelect ? pricingModeSelect.value : 'static';
      let priceOk = false;
      let qtyOk = false;

      if (pricingMode === 'premium_to_spot') {
        const premiumQtyInput = document.getElementById('qty-input-premium');
        const premiumInput = document.getElementById('bid-spot-premium');
        const floorPriceInput = document.getElementById('bid-floor-price');

        const q = Number(premiumQtyInput && premiumQtyInput.value);
        qtyOk = Number.isInteger(q) && q >= 1;

        const premium = Number(premiumInput && premiumInput.value);
        const premiumOk = isFinite(premium) && premium >= 0;

        const floor = Number(floorPriceInput && floorPriceInput.value);
        const floorOk = isFinite(floor) && floor >= 0.01;

        priceOk = premiumOk && floorOk;
      } else {
        const p = Number(priceInput && priceInput.value);
        priceOk = isFinite(p) && p >= 0.01;
        if (priceHint) priceHint.textContent = priceOk ? '' : 'Price must be at least $0.01';

        const q = Number(qtyInput && qtyInput.value);
        qtyOk = Number.isInteger(q) && q >= 1;
        if (qtyHint) qtyHint.textContent = qtyOk ? '' : 'Quantity must be at least 1';
      }

      if (confirmBtn) confirmBtn.disabled = !(priceOk && qtyOk);
    }

    // Pricing mode toggle
    function updatePricingFieldsVisibility() {
      if (!pricingModeSelect || !staticPricingFields || !premiumPricingFields) return;

      const mode = pricingModeSelect.value;
      console.log('[Bid Pricing Mode] Selected mode:', mode);

      if (mode === 'premium_to_spot') {
        staticPricingFields.style.display = 'none';
        premiumPricingFields.style.display = 'block';

        const staticQty = document.getElementById('qty-input');
        const premiumQty = document.getElementById('qty-input-premium');
        if (staticQty && premiumQty) {
          premiumQty.value = staticQty.value;
          const premiumQtyValue = document.getElementById('qty-value-premium');
          if (premiumQtyValue) premiumQtyValue.textContent = staticQty.value;
        }

        if (priceInput) priceInput.value = '';
      } else {
        staticPricingFields.style.display = 'block';
        premiumPricingFields.style.display = 'none';

        const staticQty = document.getElementById('qty-input');
        const premiumQty = document.getElementById('qty-input-premium');
        if (staticQty && premiumQty) {
          staticQty.value = premiumQty.value;
          const staticQtyValue = document.getElementById('qty-value');
          if (staticQtyValue) staticQtyValue.textContent = premiumQty.value;
        }

        const premInput = document.getElementById('bid-spot-premium');
        const floorInput = document.getElementById('bid-floor-price');
        if (premInput) premInput.value = '';
        if (floorInput) floorInput.value = '';
      }

      validateAll();
    }

    function updateEffectiveBidPrice() {
      const premInput = document.getElementById('bid-spot-premium');
      if (!premInput || !premiumDisplay || !effectiveBidPrice || !currentSpotPriceElem) return;

      const premium = Number(premInput.value) || 0;
      const spotPriceText = currentSpotPriceElem.textContent.replace(/[^0-9.]/g, '');
      const spotPrice = Number(spotPriceText) || 0;
      const effective = spotPrice + premium;

      premiumDisplay.textContent = premium.toFixed(2);
      effectiveBidPrice.textContent = effective.toFixed(2);
    }

    if (pricingModeSelect) {
      pricingModeSelect.addEventListener('change', updatePricingFieldsVisibility);
      updatePricingFieldsVisibility();
    }

    // Static quantity dial
    function clampQty(n) { return Math.max(1, Math.round(n || 1)); }
    function setQty(n) {
      const v = clampQty(n);
      if (qtyInput) qtyInput.value = String(v);
      if (qtyValue) qtyValue.textContent = String(v);
      validateAll();
    }
    setQty(1);

    let holdTimer = null, stepTimer = null;
    function startHold(delta) {
      setQty((Number(qtyInput && qtyInput.value) || 1) + delta);
      holdTimer = setTimeout(() => {
        stepTimer = setInterval(() => setQty((Number(qtyInput && qtyInput.value) || 1) + delta), 80);
      }, 350);
    }
    function stopHold() { clearTimeout(holdTimer); clearInterval(stepTimer); }

    qtyDec && qtyDec.addEventListener('mousedown', () => startHold(-1));
    qtyInc && qtyInc.addEventListener('mousedown', () => startHold(+1));
    ['mouseup','mouseleave'].forEach(ev => {
      qtyDec && qtyDec.addEventListener(ev, stopHold);
      qtyInc && qtyInc.addEventListener(ev, stopHold);
    });
    qtyInput && qtyInput.addEventListener('change', () => setQty(Number(qtyInput.value)));

    // Premium quantity dial
    const qtyDecPremium = document.getElementById('qty-dec-premium');
    const qtyIncPremium = document.getElementById('qty-inc-premium');
    const qtyInputPremium = document.getElementById('qty-input-premium');
    const qtyValuePremium = document.getElementById('qty-value-premium');

    function setQtyPremium(n) {
      const v = clampQty(n);
      if (qtyInputPremium) qtyInputPremium.value = String(v);
      if (qtyValuePremium) qtyValuePremium.textContent = String(v);
      validateAll();
    }
    setQtyPremium(1);

    let holdTimerPremium = null, stepTimerPremium = null;
    function startHoldPremium(delta) {
      setQtyPremium((Number(qtyInputPremium && qtyInputPremium.value) || 1) + delta);
      holdTimerPremium = setTimeout(() => {
        stepTimerPremium = setInterval(() => setQtyPremium((Number(qtyInputPremium && qtyInputPremium.value) || 1) + delta), 80);
      }, 350);
    }
    function stopHoldPremium() { clearTimeout(holdTimerPremium); clearInterval(stepTimerPremium); }

    qtyDecPremium && qtyDecPremium.addEventListener('mousedown', () => startHoldPremium(-1));
    qtyIncPremium && qtyIncPremium.addEventListener('mousedown', () => startHoldPremium(+1));
    ['mouseup','mouseleave'].forEach(ev => {
      qtyDecPremium && qtyDecPremium.addEventListener(ev, stopHoldPremium);
      qtyIncPremium && qtyIncPremium.addEventListener(ev, stopHoldPremium);
    });
    qtyInputPremium && qtyInputPremium.addEventListener('change', () => setQtyPremium(Number(qtyInputPremium.value)));

    // Price input validation
    if (priceInput) {
      priceInput.addEventListener('blur', () => {
        const n = Number(priceInput.value);
        if (!isFinite(n) || n <= 0) {
          if (priceHint) priceHint.textContent = 'Enter a positive price.';
        } else {
          priceInput.value = (Math.round(n * 100) / 100).toFixed(2);
          if (priceHint) priceHint.textContent = '';
        }
        validateAll();
      });
      priceInput.addEventListener('input', validateAll);
    }

    // Premium input validation
    const premiumInput = document.getElementById('bid-spot-premium');
    if (premiumInput) {
      premiumInput.addEventListener('input', () => {
        updateEffectiveBidPrice();
        validateAll();
      });
      premiumInput.addEventListener('blur', () => {
        const n = Number(premiumInput.value);
        if (!isFinite(n) || n < 0) {
          premiumInput.value = '0.00';
        } else {
          premiumInput.value = (Math.round(n * 100) / 100).toFixed(2);
        }
        updateEffectiveBidPrice();
        validateAll();
      });
    }

    // Floor price validation
    const floorPriceInput = document.getElementById('bid-floor-price');
    if (floorPriceInput) {
      floorPriceInput.addEventListener('blur', () => {
        const n = Number(floorPriceInput.value);
        if (isFinite(n) && n > 0) {
          floorPriceInput.value = (Math.round(n * 100) / 100).toFixed(2);
        }
        validateAll();
      });
      floorPriceInput.addEventListener('input', validateAll);
    }

    // Confirm button test
    confirmBtn.addEventListener('click', () => {
      const statusDiv = document.getElementById('test-status');
      const mode = pricingModeSelect.value;

      if (mode === 'static') {
        const price = priceInput.value;
        const qty = qtyInput.value;
        statusDiv.className = 'test-status success';
        statusDiv.textContent = `✓ Fixed Price Bid: ${qty} units @ $${price} each`;
      } else {
        const premium = premiumInput.value;
        const ceiling = floorPriceInput.value;
        const qty = qtyInputPremium.value;
        const effective = effectiveBidPrice.textContent;
        statusDiv.className = 'test-status success';
        statusDiv.textContent = `✓ Variable Bid: ${qty} units @ Spot + $${premium} (max $${ceiling}), Current effective: $${effective}`;
      }

      statusDiv.style.display = 'block';
    });

    // Initialize
    validateAll();
  </script>
</body>
</html>
