<!DOCTYPE html>
<html>
<head>
    <title>Frontend Remove Seller Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .test-container { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 8px; max-width: 400px; }
        .btn { padding: 10px 20px; margin: 5px; cursor: pointer; border: 1px solid #ccc; background: white; border-radius: 4px; }
        .btn-danger { background: #dc3545; color: white; border-color: #dc3545; }
        .log { background: #000; color: #0f0; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; font-size: 12px; max-height: 300px; overflow-y: auto; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <h1>Frontend Remove Seller Test</h1>

    <div class="test-container">
        <h2>Test Scenario</h2>
        <p>This simulates the exact frontend flow:</p>
        <ol>
            <li>Load the remove_seller_confirmation_modal.js script</li>
            <li>Call openRemoveSellerConfirmation(bucketId, sellerId)</li>
            <li>Verify pendingRemoval is set</li>
            <li>Click the "Remove Seller" button</li>
            <li>Verify confirmRemoveSeller() is called with correct values</li>
        </ol>

        <button onclick="runTest()" style="padding: 15px 30px; font-size: 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Run Test
        </button>
    </div>

    <div class="test-container">
        <h2>Console Log</h2>
        <div id="log" class="log"></div>
    </div>

    <div class="test-container">
        <h2>Test Results</h2>
        <div id="results"></div>
    </div>

    <!-- The actual modal HTML -->
    <div id="removeSellerConfirmModal" class="modal" style="display: none;" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <span class="modal-title">Confirm Removal</span>
            </div>

            <div class="modal-body">
                <p>Are you sure you want to remove this seller?</p>
                <p>We may not be able to replace all of the items in your order and maintain the same price point.</p>
                <p id="refill-warning" class="refill-warning-msg" style="display:none;">
                    We will not be able to refill the order completely.
                </p>
            </div>

            <div class="modal-footer">
                <button id="keepSellerBtn" class="btn" type="button" onclick="closeRemoveSellerConfirmation()">
                    Keep Seller
                </button>

                <button id="confirmRemoveSellerBtn" class="btn btn-danger" type="button" onclick="confirmRemoveSeller()">
                    Remove Seller
                </button>
            </div>
        </div>
    </div>

    <script>
        // Capture console output
        const originalLog = console.log;
        const originalError = console.error;
        const logDiv = document.getElementById('log');

        function addLog(msg, type = 'log') {
            const entry = document.createElement('div');
            entry.textContent = msg;
            entry.style.color = type === 'error' ? '#ff6b6b' : '#0f0';
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addLog(args.join(' '));
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addLog('ERROR: ' + args.join(' '), 'error');
        };
    </script>

    <!-- The actual script we're testing -->
    <script>
        // static/js/modals/remove_seller_confirmation_modal.js
        let pendingRemoval = { bucketId: null, sellerId: null };

        function openRemoveSellerConfirmation(bucketId, sellerId, canRefill = true) {
            console.log('[Remove Seller] openRemoveSellerConfirmation called with:', { bucketId, sellerId, canRefill });
            pendingRemoval = { bucketId, sellerId };
            console.log('[Remove Seller] pendingRemoval updated to:', pendingRemoval);

            const warn = document.getElementById('refill-warning');
            if (warn) {
                warn.style.display = canRefill ? 'none' : 'block';
            }
            const modal = document.getElementById('removeSellerConfirmModal');
            console.log('[Remove Seller] Modal element found:', !!modal);
            if (modal) {
                modal.style.display = 'flex';
                modal.setAttribute('aria-hidden', 'false');
                console.log('[Remove Seller] Modal opened');
            } else {
                console.error('[Remove Seller] ERROR: removeSellerConfirmModal element not found in DOM!');
            }
        }

        function closeRemoveSellerConfirmation() {
            console.log('[Remove Seller] closeRemoveSellerConfirmation called');
            const modal = document.getElementById('removeSellerConfirmModal');
            if (modal) {
                modal.style.display = 'none';
                modal.setAttribute('aria-hidden', 'true');
            }
        }

        function confirmRemoveSeller() {
            console.log('[Remove Seller] ==========================================');
            console.log('[Remove Seller] confirmRemoveSeller CALLED');
            console.log('[Remove Seller] Current pendingRemoval:', pendingRemoval);
            console.log('[Remove Seller] ==========================================');

            const { bucketId, sellerId } = pendingRemoval;

            if (!bucketId || !sellerId) {
                console.error('[Remove Seller] ERROR: Missing bucketId or sellerId!', { bucketId, sellerId });
                alert('Invalid request. Please try again.');
                return;
            }

            const url = `/cart/remove_seller/${bucketId}/${sellerId}`;
            console.log('[Remove Seller] Would send POST to:', url);
            console.log('[Remove Seller] SUCCESS: Function called correctly with:', { bucketId, sellerId });

            // Don't actually make the request in the test
            // Just verify the function was called correctly
            closeRemoveSellerConfirmation();

            return { success: true, bucketId, sellerId, url };
        }

        // Expose globally
        window.openRemoveSellerConfirmation  = openRemoveSellerConfirmation;
        window.closeRemoveSellerConfirmation = closeRemoveSellerConfirmation;
        window.confirmRemoveSeller           = confirmRemoveSeller;

        console.log('[Remove Seller] Script loaded. Functions exposed:', {
            openRemoveSellerConfirmation: typeof window.openRemoveSellerConfirmation,
            closeRemoveSellerConfirmation: typeof window.closeRemoveSellerConfirmation,
            confirmRemoveSeller: typeof window.confirmRemoveSeller
        });
    </script>

    <script>
        function runTest() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<h3>Running tests...</h3>';
            const results = [];

            // Test 1: Functions are exposed
            console.log('\n=== TEST 1: Functions Exposed ===');
            const test1 = typeof window.confirmRemoveSeller === 'function' &&
                         typeof window.openRemoveSellerConfirmation === 'function' &&
                         typeof window.closeRemoveSellerConfirmation === 'function';
            results.push({ name: 'Functions exposed on window', passed: test1 });
            console.log('Result:', test1 ? 'PASS' : 'FAIL');

            // Test 2: Open confirmation modal
            console.log('\n=== TEST 2: Open Confirmation Modal ===');
            openRemoveSellerConfirmation(26313121, 11, true);
            const modal = document.getElementById('removeSellerConfirmModal');
            const test2 = modal && modal.style.display === 'flex';
            results.push({ name: 'Modal opens correctly', passed: test2 });
            console.log('Result:', test2 ? 'PASS' : 'FAIL');

            // Test 3: pendingRemoval is set
            console.log('\n=== TEST 3: pendingRemoval Set ===');
            const test3 = pendingRemoval.bucketId === 26313121 && pendingRemoval.sellerId === 11;
            results.push({ name: 'pendingRemoval set correctly', passed: test3 });
            console.log('Result:', test3 ? 'PASS' : 'FAIL');
            console.log('pendingRemoval:', pendingRemoval);

            // Test 4: Click button programmatically
            console.log('\n=== TEST 4: Click Remove Seller Button ===');
            const confirmBtn = document.getElementById('confirmRemoveSellerBtn');
            if (confirmBtn) {
                console.log('Button found, simulating click...');
                confirmBtn.click();
                // Check if modal closed
                const test4 = modal.style.display === 'none';
                results.push({ name: 'Button click triggers confirmRemoveSeller', passed: test4 });
                console.log('Result:', test4 ? 'PASS' : 'FAIL');
            } else {
                results.push({ name: 'Button click triggers confirmRemoveSeller', passed: false });
                console.error('Button not found!');
            }

            // Display results
            let html = '<table style="width:100%; border-collapse: collapse;">';
            html += '<tr style="background:#f0f0f0;"><th style="padding:10px; text-align:left;">Test</th><th style="padding:10px;">Result</th></tr>';

            results.forEach(r => {
                const resultClass = r.passed ? 'success' : 'error';
                const resultText = r.passed ? 'PASS' : 'FAIL';
                html += `<tr><td style="padding:10px; border-top:1px solid #ddd;">${r.name}</td><td style="padding:10px; border-top:1px solid #ddd;" class="${resultClass}">${resultText}</td></tr>`;
            });

            html += '</table>';

            const allPassed = results.every(r => r.passed);
            if (allPassed) {
                html += '<h2 class="success">ALL TESTS PASSED!</h2>';
                html += '<p>The frontend JavaScript is working correctly. The button should work in the actual application.</p>';
            } else {
                html += '<h2 class="error">SOME TESTS FAILED</h2>';
            }

            resultsDiv.innerHTML = html;
        }
    </script>
</body>
</html>
