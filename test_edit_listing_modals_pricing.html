<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Edit Listing Modals - Pricing Display</title>
  <link rel="stylesheet" href="/static/css/modals/edit_listing_confirmation_modals.css">
  <link rel="stylesheet" href="/static/css/modals/modal-close-button.css">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      padding: 40px;
      background: #f3f4f6;
    }
    .test-controls {
      max-width: 800px;
      margin: 0 auto 40px;
      background: white;
      padding: 32px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      margin: 0 0 24px 0;
      font-size: 28px;
      color: #111827;
    }
    .test-section {
      margin-bottom: 32px;
      padding-bottom: 32px;
      border-bottom: 1px solid #e5e7eb;
    }
    .test-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }
    h2 {
      font-size: 20px;
      color: #374151;
      margin: 0 0 16px 0;
    }
    .test-button {
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      margin-right: 12px;
      margin-bottom: 12px;
      transition: all 0.2s;
    }
    .test-button.primary {
      background: #0066cc;
      color: white;
    }
    .test-button.primary:hover {
      background: #0052a3;
    }
    .test-button.secondary {
      background: #10b981;
      color: white;
    }
    .test-button.secondary:hover {
      background: #059669;
    }
    .test-info {
      background: #f0f9ff;
      border: 1px solid #bae6fd;
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
      font-size: 14px;
      line-height: 1.6;
    }
    .test-info strong {
      color: #0369a1;
    }
    .console-output {
      background: #1f2937;
      color: #10b981;
      padding: 16px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 300px;
      overflow-y: auto;
      margin-top: 16px;
    }
    .console-output .error {
      color: #ef4444;
    }
    .console-output .info {
      color: #60a5fa;
    }
  </style>
</head>
<body>
  <div class="test-controls">
    <h1>Edit Listing Modals - Pricing Display Test</h1>
    <p style="color: #6b7280; margin-bottom: 32px;">
      This test verifies that both static and premium-to-spot listings display correctly in the confirmation and success modals.
    </p>

    <!-- Test 1: Static Pricing -->
    <div class="test-section">
      <h2>Test 1: Static (Fixed Price) Listing</h2>
      <button class="test-button primary" onclick="testStaticPricingConfirmation()">
        Test Static Confirmation Modal
      </button>
      <button class="test-button secondary" onclick="testStaticPricingSuccess()">
        Test Static Success Modal
      </button>
      <div class="test-info">
        <strong>Expected Results:</strong><br>
        ✓ Pricing Mode: "Fixed Price"<br>
        ✓ Price per Item: $125.00 (valid number, no $NaN)<br>
        ✓ No variable pricing fields shown (Current Spot Price, Premium, Floor, Effective Price)<br>
        ✓ All item details displayed on separate lines
      </div>
    </div>

    <!-- Test 2: Premium-to-Spot Pricing -->
    <div class="test-section">
      <h2>Test 2: Premium-to-Spot (Variable) Listing</h2>
      <button class="test-button primary" onclick="testVariablePricingConfirmation()">
        Test Variable Confirmation Modal
      </button>
      <button class="test-button secondary" onclick="testVariablePricingSuccess()">
        Test Variable Success Modal
      </button>
      <div class="test-info">
        <strong>Expected Results:</strong><br>
        ✓ Pricing Mode: "Variable (Premium to Spot)"<br>
        ✓ Current Spot Price: $2,350.50/oz (fetched from API)<br>
        ✓ Premium Above Spot: $50.00<br>
        ✓ Floor Price (Minimum): $100.00<br>
        ✓ Current Effective Price: $2,400.50 (calculated as: (2350.50 × 1 oz) + 50, respecting floor)<br>
        ✓ All values are real numbers, NO $NaN<br>
        ✓ All item details displayed on separate lines
      </div>
    </div>

    <!-- Test 3: Variable with Weight -->
    <div class="test-section">
      <h2>Test 3: Premium-to-Spot with Different Weight (1/10 oz)</h2>
      <button class="test-button primary" onclick="testVariableWithWeight()">
        Test 1/10 oz Variable Listing
      </button>
      <div class="test-info">
        <strong>Expected Results:</strong><br>
        ✓ Current Spot Price: $2,350.50/oz<br>
        ✓ Premium Above Spot: $25.00<br>
        ✓ Floor Price: $50.00<br>
        ✓ Weight: 0.1 oz<br>
        ✓ Current Effective Price: $260.05 (calculated as: (2350.50 × 0.1) + 25 = 260.05, max(260.05, 50) = 260.05)<br>
        ✓ All calculations correct for fractional ounce weights
      </div>
    </div>

    <!-- Console Output -->
    <div class="test-section">
      <h2>Console Output</h2>
      <div id="console" class="console-output">
        Waiting for tests to run...
      </div>
    </div>
  </div>

  <!-- Include modal templates -->
  <div id="modal-container"></div>

  <script>
    // Capture console logs
    const consoleDiv = document.getElementById('console');
    const originalLog = console.log;
    const originalError = console.error;

    function logToConsole(message, type = 'log') {
      const span = document.createElement('div');
      span.className = type;
      span.textContent = message;
      consoleDiv.appendChild(span);
      consoleDiv.scrollTop = consoleDiv.scrollHeight;
    }

    console.log = function(...args) {
      originalLog.apply(console, args);
      logToConsole(args.join(' '), 'info');
    };

    console.error = function(...args) {
      originalError.apply(console, args);
      logToConsole('ERROR: ' + args.join(' '), 'error');
    };

    // Load modal templates
    async function loadModals() {
      try {
        const response = await fetch('/templates/modals/edit_listing_confirmation_modals.html');
        const html = await response.text();
        document.getElementById('modal-container').innerHTML = html;
        console.log('✓ Modal templates loaded successfully');
      } catch (error) {
        console.error('Failed to load modal templates:', error);
      }
    }

    // Load modal JavaScript
    async function loadModalScript() {
      try {
        const script = document.createElement('script');
        script.src = '/static/js/modals/edit_listing_confirmation_modals.js';
        script.onload = () => {
          console.log('✓ Modal JavaScript loaded successfully');
        };
        script.onerror = () => {
          console.error('Failed to load modal JavaScript');
        };
        document.body.appendChild(script);
      } catch (error) {
        console.error('Error loading modal script:', error);
      }
    }

    // Test 1: Static Pricing Confirmation Modal
    async function testStaticPricingConfirmation() {
      console.log('\n=== TEST 1: Static Pricing Confirmation Modal ===');

      const testData = {
        listingId: 'test-static-1',
        metal: 'Gold',
        productLine: 'American Eagle',
        productType: 'Coin',
        weight: '1 oz',
        year: '2023',
        mint: 'US Mint',
        finish: 'Brilliant Uncirculated',
        grade: 'MS70',
        purity: '0.9999',
        quantity: 5,
        graded: true,
        gradingService: 'PCGS',
        pricingMode: 'static',
        pricePerCoin: 125.00,
        hasPhoto: true,
        formData: new FormData()
      };

      console.log('Opening static pricing confirmation modal...');
      await window.openEditListingConfirmModal(testData);

      // Verify display
      setTimeout(() => {
        const modeEl = document.getElementById('edit-confirm-mode');
        const staticPriceEl = document.getElementById('edit-confirm-static-price');
        const premiumRow = document.getElementById('edit-confirm-premium-row');

        console.log('Pricing Mode:', modeEl?.textContent);
        console.log('Static Price:', staticPriceEl?.textContent);
        console.log('Premium Row Display:', premiumRow?.style.display);

        if (modeEl?.textContent === 'Fixed Price' &&
            staticPriceEl?.textContent === '$125.00' &&
            premiumRow?.style.display === 'none') {
          console.log('✓ Static pricing confirmation modal displays correctly');
        } else {
          console.error('✗ Static pricing confirmation modal has display issues');
        }
      }, 500);
    }

    // Test 2: Static Pricing Success Modal
    async function testStaticPricingSuccess() {
      console.log('\n=== TEST 2: Static Pricing Success Modal ===');

      const testData = {
        listingId: 'test-static-1',
        metal: 'Gold',
        productLine: 'American Eagle',
        productType: 'Coin',
        weight: '1 oz',
        quantity: 5,
        graded: true,
        gradingService: 'PCGS',
        pricingMode: 'static',
        pricePerCoin: 125.00,
        hasPhoto: true
      };

      console.log('Opening static pricing success modal...');
      window.openEditListingSuccessModal(testData);

      // Verify display
      setTimeout(() => {
        const pricingModeEl = document.getElementById('success-pricing-mode');
        const staticPriceEl = document.getElementById('success-static-price');
        const premiumRow = document.getElementById('success-premium-row');

        console.log('Pricing Mode:', pricingModeEl?.textContent);
        console.log('Static Price:', staticPriceEl?.textContent);
        console.log('Premium Row Display:', premiumRow?.style.display);

        if (pricingModeEl?.textContent === 'Fixed Price' &&
            staticPriceEl?.textContent === '$125.00' &&
            premiumRow?.style.display === 'none') {
          console.log('✓ Static pricing success modal displays correctly');
        } else {
          console.error('✗ Static pricing success modal has display issues');
        }
      }, 500);
    }

    // Test 3: Variable Pricing Confirmation Modal
    async function testVariablePricingConfirmation() {
      console.log('\n=== TEST 3: Variable Pricing Confirmation Modal ===');

      const testData = {
        listingId: 'test-variable-1',
        metal: 'Gold',
        productLine: 'American Eagle',
        productType: 'Coin',
        weight: '1 oz',
        year: '2024',
        mint: 'US Mint',
        finish: 'Proof',
        grade: 'PR70',
        purity: '0.9999',
        quantity: 3,
        graded: true,
        gradingService: 'NGC',
        pricingMode: 'premium_to_spot',
        spotPremium: 50.00,
        floorPrice: 100.00,
        pricingMetal: 'Gold',
        hasPhoto: true,
        formData: new FormData()
      };

      console.log('Opening variable pricing confirmation modal...');
      await window.openEditListingConfirmModal(testData);

      // Verify display after API call completes
      setTimeout(() => {
        const modeEl = document.getElementById('edit-confirm-mode');
        const currentSpotEl = document.getElementById('edit-confirm-current-spot');
        const premiumEl = document.getElementById('edit-confirm-premium');
        const floorEl = document.getElementById('edit-confirm-floor');
        const effectiveEl = document.getElementById('edit-confirm-effective');

        console.log('Pricing Mode:', modeEl?.textContent);
        console.log('Current Spot Price:', currentSpotEl?.textContent);
        console.log('Premium Above Spot:', premiumEl?.textContent);
        console.log('Floor Price:', floorEl?.textContent);
        console.log('Current Effective Price:', effectiveEl?.textContent);

        // Check for $NaN
        if (effectiveEl?.textContent.includes('NaN')) {
          console.error('✗ FOUND $NaN IN EFFECTIVE PRICE!');
        } else if (effectiveEl?.textContent.startsWith('$') && parseFloat(effectiveEl.textContent.replace(/[$,]/g, '')) > 0) {
          console.log('✓ Variable pricing confirmation modal displays correctly');
          console.log('✓ No $NaN found - all prices are valid numbers');
        } else {
          console.error('✗ Variable pricing confirmation modal has display issues');
        }
      }, 1500); // Wait longer for API call
    }

    // Test 4: Variable Pricing Success Modal
    async function testVariablePricingSuccess() {
      console.log('\n=== TEST 4: Variable Pricing Success Modal ===');

      // Simulate data that would come from confirmation modal (with calculated prices)
      const testData = {
        listingId: 'test-variable-1',
        metal: 'Gold',
        productLine: 'American Eagle',
        productType: 'Coin',
        weight: '1 oz',
        quantity: 3,
        graded: true,
        gradingService: 'NGC',
        pricingMode: 'premium_to_spot',
        spotPremium: 50.00,
        floorPrice: 100.00,
        pricingMetal: 'Gold',
        currentSpotPrice: 2350.50,  // From API
        effectivePrice: 2400.50,     // Calculated: (2350.50 × 1) + 50 = 2400.50
        hasPhoto: true
      };

      console.log('Opening variable pricing success modal...');
      window.openEditListingSuccessModal(testData);

      // Verify display
      setTimeout(() => {
        const pricingModeEl = document.getElementById('success-pricing-mode');
        const currentSpotEl = document.getElementById('success-current-spot');
        const premiumEl = document.getElementById('success-premium');
        const floorEl = document.getElementById('success-floor');
        const effectiveEl = document.getElementById('success-effective');

        console.log('Pricing Mode:', pricingModeEl?.textContent);
        console.log('Current Spot Price:', currentSpotEl?.textContent);
        console.log('Premium Above Spot:', premiumEl?.textContent);
        console.log('Floor Price:', floorEl?.textContent);
        console.log('Current Effective Price:', effectiveEl?.textContent);

        // Check for $NaN
        if (effectiveEl?.textContent.includes('NaN')) {
          console.error('✗ FOUND $NaN IN EFFECTIVE PRICE!');
        } else if (effectiveEl?.textContent === '$2400.50') {
          console.log('✓ Variable pricing success modal displays correctly');
          console.log('✓ No $NaN found - all prices are valid numbers');
        } else {
          console.error('✗ Variable pricing success modal has display issues');
        }
      }, 500);
    }

    // Test 5: Variable Pricing with Different Weight
    async function testVariableWithWeight() {
      console.log('\n=== TEST 5: Variable Pricing with 1/10 oz Weight ===');

      const testData = {
        listingId: 'test-variable-2',
        metal: 'Gold',
        productLine: 'American Eagle',
        productType: 'Coin',
        weight: '0.1 oz',
        year: '2024',
        mint: 'US Mint',
        finish: 'Brilliant Uncirculated',
        grade: 'MS69',
        quantity: 10,
        graded: true,
        gradingService: 'PCGS',
        pricingMode: 'premium_to_spot',
        spotPremium: 25.00,
        floorPrice: 50.00,
        pricingMetal: 'Gold',
        hasPhoto: true,
        formData: new FormData()
      };

      console.log('Opening variable pricing confirmation modal for 1/10 oz coin...');
      console.log('Expected calculation: (2350.50 × 0.1) + 25 = 260.05');
      console.log('Floor check: max(260.05, 50.00) = 260.05');

      await window.openEditListingConfirmModal(testData);

      // Verify display
      setTimeout(() => {
        const effectiveEl = document.getElementById('edit-confirm-effective');
        const weightEl = document.getElementById('edit-confirm-weight');

        console.log('Weight:', weightEl?.textContent);
        console.log('Current Effective Price:', effectiveEl?.textContent);

        if (effectiveEl?.textContent.includes('NaN')) {
          console.error('✗ FOUND $NaN IN EFFECTIVE PRICE!');
        } else {
          const price = parseFloat(effectiveEl?.textContent.replace(/[$,]/g, ''));
          if (Math.abs(price - 260.05) < 0.5) { // Allow small rounding differences
            console.log('✓ Weight-adjusted pricing calculates correctly');
            console.log('✓ Formula verified: (spot × weight) + premium, respecting floor');
          } else {
            console.error('✗ Calculation mismatch. Expected ~$260.05, got:', effectiveEl?.textContent);
          }
        }
      }, 1500);
    }

    // Initialize
    window.addEventListener('DOMContentLoaded', async () => {
      console.log('=== Edit Listing Modals Pricing Test ===');
      console.log('Loading modal templates and scripts...\n');
      await loadModals();
      await loadModalScript();
      console.log('\nReady for testing! Click the buttons above to test each scenario.\n');
    });
  </script>
</body>
</html>
