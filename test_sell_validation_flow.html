<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sell Page Validation Flow Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #1877ff;
            padding-bottom: 10px;
        }
        h2 {
            color: #555;
            font-size: 18px;
            margin-top: 0;
        }
        .test-case {
            background: #f9f9f9;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #1877ff;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .test-pass {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .test-fail {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .test-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .expected {
            font-style: italic;
            color: #666;
            margin: 5px 0;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #1877ff;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background: #0056d1;
        }
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>Sell Page Validation Flow Test</h1>

    <div class="test-section">
        <h2>Test Overview</h2>
        <p>This test verifies that the Sell page validation modal runs <strong>before</strong> the confirmation modal.</p>
        <div class="test-info">
            <strong>Validation Flow:</strong>
            <ol>
                <li>User fills out sell form and clicks "List Item"</li>
                <li><strong>Validation runs FIRST</strong> - checks for empty fields and invalid dropdown values</li>
                <li>If validation fails → Show error modal with specific issues</li>
                <li>If validation passes → Show confirmation modal</li>
            </ol>
        </div>
    </div>

    <div class="test-section">
        <h2>Test Case 1: Empty Required Fields</h2>
        <div class="test-case">
            <strong>Scenario:</strong> Submit form with missing required fields<br>
            <span class="expected">Expected: Validation error modal should appear listing missing fields</span>
        </div>
        <div id="test1-result"></div>
        <button onclick="runTest1()">Run Test 1</button>
    </div>

    <div class="test-section">
        <h2>Test Case 2: Invalid Dropdown Value</h2>
        <div class="test-case">
            <strong>Scenario:</strong> Enter a value not in the allowed dropdown list<br>
            <span class="expected">Expected: Validation error modal should show "not a valid option" message</span>
        </div>
        <div id="test2-result"></div>
        <button onclick="runTest2()">Run Test 2</button>
    </div>

    <div class="test-section">
        <h2>Test Case 3: Valid Form Data</h2>
        <div class="test-case">
            <strong>Scenario:</strong> Submit form with all valid data<br>
            <span class="expected">Expected: Validation passes, confirmation modal appears (NOT validation error modal)</span>
        </div>
        <div id="test3-result"></div>
        <button onclick="runTest3()">Run Test 3</button>
    </div>

    <div class="test-section">
        <h2>Test Case 4: Multiple Validation Errors</h2>
        <div class="test-case">
            <strong>Scenario:</strong> Submit form with both empty fields AND invalid dropdown values<br>
            <span class="expected">Expected: Validation error modal shows all issues in a list</span>
        </div>
        <div id="test4-result"></div>
        <button onclick="runTest4()">Run Test 4</button>
    </div>

    <!-- Include field labels from validation modal -->
    <script>
        const FIELD_LABELS = {
            'metal': 'Metal',
            'product_line': 'Product Line',
            'product_type': 'Product Type',
            'weight': 'Weight',
            'purity': 'Purity',
            'mint': 'Mint',
            'year': 'Year',
            'finish': 'Finish',
            'grade': 'Grade',
            'quantity': 'Quantity',
            'price_per_coin': 'Price Per Coin',
            'item_photo': 'Item Photo'
        };

        // Mock the validation function from field_validation_modal.js
        function validateForm(form, requiredFields) {
            const errors = [];

            requiredFields.forEach(fieldName => {
                const field = form.elements[fieldName];

                if (!field) {
                    return;
                }

                // Handle file inputs
                if (field.type === 'file') {
                    if (!field.files || field.files.length === 0) {
                        errors.push(`${FIELD_LABELS[fieldName] || fieldName} is required`);
                    }
                }
                // Handle text/select inputs
                else {
                    const value = (field.value || '').trim();

                    // Check if empty
                    if (!value || value === '') {
                        errors.push(`${FIELD_LABELS[fieldName] || fieldName} is required`);
                    }
                    // Check if field has datalist validation
                    else if (field.classList.contains('validated-datalist')) {
                        const listId = field.dataset.listId;
                        const listEl = document.getElementById(listId);

                        if (listEl) {
                            // Get allowed values from datalist
                            const allowed = Array.from(listEl.options).map(opt => (opt.value || '').trim());

                            // Check if value is in allowed list (case-sensitive)
                            if (!allowed.includes(value)) {
                                errors.push(`"${value}" is not a valid option for ${FIELD_LABELS[fieldName] || fieldName}. Please choose from the dropdown list.`);
                            }
                        }
                    }
                }
            });

            return {
                isValid: errors.length === 0,
                errors: errors
            };
        }

        function createMockForm() {
            const form = document.createElement('form');
            form.id = 'mockSellForm';

            const fields = [
                { name: 'metal', type: 'text', datalist: ['Gold', 'Silver', 'Platinum'] },
                { name: 'product_line', type: 'text', datalist: ['American Eagle', 'Canadian Maple Leaf'] },
                { name: 'product_type', type: 'text', datalist: ['Coin', 'Bar'] },
                { name: 'weight', type: 'text', datalist: ['1 oz', '5 oz', '10 oz'] },
                { name: 'purity', type: 'text', datalist: ['.9999', '.999'] },
                { name: 'mint', type: 'text', datalist: ['US Mint', 'Royal Canadian Mint'] },
                { name: 'year', type: 'text', datalist: ['2024', '2025'] },
                { name: 'finish', type: 'text', datalist: ['Proof', 'Brilliant Uncirculated'] },
                { name: 'grade', type: 'text', datalist: ['MS-70', 'PF-70'] },
                { name: 'quantity', type: 'text', datalist: [] },
                { name: 'price_per_coin', type: 'text', datalist: [] },
                { name: 'item_photo', type: 'file', datalist: [] }
            ];

            fields.forEach(fieldConfig => {
                const input = document.createElement('input');
                input.type = fieldConfig.type;
                input.name = fieldConfig.name;
                input.id = fieldConfig.name;

                if (fieldConfig.datalist.length > 0) {
                    input.classList.add('validated-datalist');
                    input.dataset.listId = `${fieldConfig.name}_options`;

                    const datalist = document.createElement('datalist');
                    datalist.id = `${fieldConfig.name}_options`;

                    fieldConfig.datalist.forEach(option => {
                        const opt = document.createElement('option');
                        opt.value = option;
                        datalist.appendChild(opt);
                    });

                    form.appendChild(datalist);
                }

                form.appendChild(input);
            });

            return form;
        }

        function runTest1() {
            const resultDiv = document.getElementById('test1-result');
            resultDiv.innerHTML = '<div class="test-info">Running test...</div>';

            // Create mock form with empty fields
            const form = createMockForm();

            const requiredFields = ['metal', 'product_line', 'product_type', 'weight', 'purity', 'mint', 'year', 'finish', 'grade', 'quantity', 'price_per_coin', 'item_photo'];

            const validation = validateForm(form, requiredFields);

            if (!validation.isValid && validation.errors.length === 12) {
                resultDiv.innerHTML = `
                    <div class="test-pass">
                        <strong>✓ PASS:</strong> Validation correctly detected ${validation.errors.length} missing required fields<br>
                        <strong>Errors:</strong>
                        <ul>${validation.errors.slice(0, 5).map(e => `<li>${e}</li>`).join('')}<li>... and ${validation.errors.length - 5} more</li></ul>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `<div class="test-fail"><strong>✗ FAIL:</strong> Expected 12 errors, got ${validation.errors.length}</div>`;
            }
        }

        function runTest2() {
            const resultDiv = document.getElementById('test2-result');
            resultDiv.innerHTML = '<div class="test-info">Running test...</div>';

            // Create mock form
            const form = createMockForm();

            // Fill all fields with valid values
            form.elements['metal'].value = 'Gold';
            form.elements['product_line'].value = 'American Eagle';
            form.elements['product_type'].value = 'Coin';
            form.elements['weight'].value = '1 oz';
            form.elements['purity'].value = '.9999';
            form.elements['mint'].value = 'US Mint';
            form.elements['year'].value = '2025';
            form.elements['finish'].value = 'Proof';
            form.elements['grade'].value = 'MS-70';
            form.elements['quantity'].value = '10';
            form.elements['price_per_coin'].value = '2500.00';

            // Set INVALID value for metal
            form.elements['metal'].value = 'Copper';  // Not in allowed list

            // Mock file upload
            const fileList = {
                length: 1,
                0: new File(["test"], "test.jpg", { type: "image/jpeg" })
            };
            Object.defineProperty(form.elements['item_photo'], 'files', {
                value: fileList,
                writable: false
            });

            const requiredFields = ['metal', 'product_line', 'product_type', 'weight', 'purity', 'mint', 'year', 'finish', 'grade', 'quantity', 'price_per_coin', 'item_photo'];

            const validation = validateForm(form, requiredFields);

            if (!validation.isValid && validation.errors.length === 1 && validation.errors[0].includes('not a valid option')) {
                resultDiv.innerHTML = `
                    <div class="test-pass">
                        <strong>✓ PASS:</strong> Validation correctly detected invalid dropdown value<br>
                        <strong>Error Message:</strong> ${validation.errors[0]}
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `<div class="test-fail"><strong>✗ FAIL:</strong> Expected 1 "not a valid option" error, got: ${JSON.stringify(validation.errors)}</div>`;
            }
        }

        function runTest3() {
            const resultDiv = document.getElementById('test3-result');
            resultDiv.innerHTML = '<div class="test-info">Running test...</div>';

            // Create mock form
            const form = createMockForm();

            // Fill all fields with VALID values
            form.elements['metal'].value = 'Gold';
            form.elements['product_line'].value = 'American Eagle';
            form.elements['product_type'].value = 'Coin';
            form.elements['weight'].value = '1 oz';
            form.elements['purity'].value = '.9999';
            form.elements['mint'].value = 'US Mint';
            form.elements['year'].value = '2025';
            form.elements['finish'].value = 'Proof';
            form.elements['grade'].value = 'MS-70';
            form.elements['quantity'].value = '10';
            form.elements['price_per_coin'].value = '2500.00';

            // Mock file upload
            const fileList = {
                length: 1,
                0: new File(["test"], "test.jpg", { type: "image/jpeg" })
            };
            Object.defineProperty(form.elements['item_photo'], 'files', {
                value: fileList,
                writable: false
            });

            const requiredFields = ['metal', 'product_line', 'product_type', 'weight', 'purity', 'mint', 'year', 'finish', 'grade', 'quantity', 'price_per_coin', 'item_photo'];

            const validation = validateForm(form, requiredFields);

            if (validation.isValid && validation.errors.length === 0) {
                resultDiv.innerHTML = `
                    <div class="test-pass">
                        <strong>✓ PASS:</strong> Validation passed with all valid data<br>
                        <strong>Next Step:</strong> Confirmation modal should appear (not validation error modal)
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `<div class="test-fail"><strong>✗ FAIL:</strong> Expected validation to pass, but got errors: ${JSON.stringify(validation.errors)}</div>`;
            }
        }

        function runTest4() {
            const resultDiv = document.getElementById('test4-result');
            resultDiv.innerHTML = '<div class="test-info">Running test...</div>';

            // Create mock form
            const form = createMockForm();

            // Leave some fields empty AND set invalid values for others
            form.elements['metal'].value = 'Copper';  // INVALID - not in list
            form.elements['product_line'].value = '';  // EMPTY
            form.elements['product_type'].value = 'Round';  // INVALID - not in list
            form.elements['weight'].value = '1 oz';  // VALID
            form.elements['purity'].value = '';  // EMPTY
            form.elements['mint'].value = 'US Mint';  // VALID
            form.elements['year'].value = '2025';  // VALID
            form.elements['finish'].value = '';  // EMPTY
            form.elements['grade'].value = 'MS-70';  // VALID
            form.elements['quantity'].value = '';  // EMPTY
            form.elements['price_per_coin'].value = '';  // EMPTY
            // item_photo: no file (EMPTY)

            const requiredFields = ['metal', 'product_line', 'product_type', 'weight', 'purity', 'mint', 'year', 'finish', 'grade', 'quantity', 'price_per_coin', 'item_photo'];

            const validation = validateForm(form, requiredFields);

            const emptyFieldErrors = validation.errors.filter(e => e.includes('is required'));
            const invalidValueErrors = validation.errors.filter(e => e.includes('not a valid option'));

            if (!validation.isValid && emptyFieldErrors.length > 0 && invalidValueErrors.length > 0) {
                resultDiv.innerHTML = `
                    <div class="test-pass">
                        <strong>✓ PASS:</strong> Validation correctly detected multiple error types<br>
                        <strong>Total Errors:</strong> ${validation.errors.length}<br>
                        <strong>Empty Fields:</strong> ${emptyFieldErrors.length}<br>
                        <strong>Invalid Values:</strong> ${invalidValueErrors.length}<br>
                        <strong>Sample Errors:</strong>
                        <ul>${validation.errors.slice(0, 5).map(e => `<li>${e}</li>`).join('')}</ul>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `<div class="test-fail"><strong>✗ FAIL:</strong> Expected multiple error types. Got: ${JSON.stringify(validation.errors)}</div>`;
            }
        }

        // Run all tests on page load
        window.addEventListener('load', () => {
            setTimeout(() => {
                runTest1();
                setTimeout(() => runTest2(), 100);
                setTimeout(() => runTest3(), 200);
                setTimeout(() => runTest4(), 300);
            }, 500);
        });
    </script>
</body>
</html>
